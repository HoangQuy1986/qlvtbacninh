<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hợp Đồng Lao Động HTX</title>

    <!-- Thêm các thư viện cần thiết cho xuất Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @page {
            size: A4;
            margin: 0;
        }

        body {
            font-family: "Times New Roman", serif;
            font-size: 14px;
            line-height: 1.5;
            background: white;
            width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            min-height: 297mm;
            position: relative;
        }

        .button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: "Times New Roman", serif;
        }

        .print-button {
            background-color: #4CAF50;
            color: white;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        .export-button {
            background-color: #2b579a;
            color: white;
        }

        .export-button:hover {
            background-color: #1e3f6f;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }

        /* Document header styling */
        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .header-left {
            font-weight: bold;
            font-size: 14px;
            width: 45%;
        }

        .header-left .org-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-right {
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            width: 50%;
        }

        .header-right .country {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-right .motto {
            text-decoration: underline;
            font-style: italic;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .header-right .location-date {
            font-style: italic;
            font-weight: normal;
        }

        /* Title styling */
        .document-title {
            text-align: center;
            margin: 20px 0;
        }

        .title-main {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .title-sub {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Legal basis */
        .legal-basis {
            margin: 15px 0;
            line-height: 1.6;
        }

        .legal-basis p {
            margin-bottom: 8px;
        }

        /* Contract parties */
        .contract-parties {
            margin: 15px 0;
            text-align: justify;
            line-height: 1.6;
        }

        .party-section {
            margin-bottom: 15px;
        }

        .party-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .party-content p {
            margin-bottom: 6px;
        }

        /* Content styling */
        .article {
            margin: 15px 0;
            text-align: justify;
        }

        .article-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .article-content {
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .article-content p {
            margin-bottom: 6px;
        }

        .indent-content {
            margin-left: 20px;
            margin-bottom: 6px;
        }

        .sub-section {
            margin: 8px 0;
        }

        .sub-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .list-item {
            margin-left: 20px;
            margin-bottom: 6px;
        }

        /* Signature section */
        .signature-section {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }

        .signature-left,
        .signature-right {
            width: 45%;
            text-align: center;
        }

        .signature-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .signature-name {
            font-weight: bold;
            margin-top: 80px;
        }

        @media print {
            body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 20mm;
            }

            .button-container {
                display: none;
            }
        }

        @media screen {
            body {
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                margin: 20px auto;
            }
        }

        .bold {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Button Container -->
    <div class="button-container">
        <button class="button print-button" onclick="window.print()">
            <i class="fas fa-print"></i> In Tài Liệu
        </button>
        <button class="button export-button" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <!-- Document Content -->
    <div class="document-header">
        <div class="header-left">
            <div class="org-name bold" id="ten-don-vi-upper"></div>
            <div>Số: <span id="so-van-ban">...</span></div>
        </div>
        <div class="header-right">
            <div class="country">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
            <div class="motto">Độc lập - Tự do - Hạnh phúc</div>
            <div class="location-date">
                <em><span id="tinh">Bắc Ninh</span>, ngày <span id="ngay">...</span> tháng <span id="thang">...</span>
                    năm <span id="nam">...</span></em>
            </div>
        </div>
    </div>

    <div class="document-title">
        <div class="title-main">HỢP ĐỒNG LAO ĐỘNG</div>
        <div class="title-sub">Về việc ký kết hợp đồng lao động đối với nhân viên lái xe</div>
    </div>

    <div class="legal-basis">
        <p>Căn cứ Bộ Luật Lao động năm 2019 và các văn bản hướng dẫn hiện hành;</p>
        <p>Và sự thỏa thuận của các bên là:</p>
    </div>

    <div class="contract-parties">
        <div class="party-section">
            <div class="party-title">A. NGƯỜI SỬ DỤNG LAO ĐỘNG: <span id="ten-don-vi-a" class="bold">...</span></div>
            <div class="party-content">
                <p>Giấy chứng nhận đăng ký kinh doanh số 2301328849 do Phòng Tài chính - Kế hoạch thành phố Bắc Ninh cấp ngày 09/4/2025</p>
                <p>Địa chỉ: <span id="dia-chi-don-vi">...</span></p>
                <p>Điện thoại: <span id="so-dt">...</span> Fax:</p>
                <p>Đại diện: Ông <span id="nguoi-dai-dien">...</span> - Chức vụ: <span id="chuc-vu-nguoi-dai-dien">...</span></p>
            </div>
        </div>

        <div class="party-section">
            <div class="party-title">B. NGƯỜI LAO ĐỘNG: ÔNG/BÀ <span id="ho-ten-upper" class="bold">...</span></div>
            <div class="party-content">
                <p>Ngày sinh: <span id="ngay-sinh">...</span></p>
                <p>Địa chỉ: <span id="dia-chi-nhan-su">...</span></p>
                <p>Căn cước công dân số: <span id="so-cccd">...</span> ngày cấp: <span id="ngay-cap-cccd">...</span></p>
                <p>Nơi cấp: <span id="noi-cap-cccd">...</span></p>
            </div>
        </div>

        <p style="margin-top: 15px;">Sau khi thỏa thuận, hai Bên thống nhất ký Hợp đồng lao động (sau đây gọi là "Hợp đồng") với các điều khoản sau đây:</p>
    </div>

    <div class="article">
        <div class="article-title">Điều 1. Thời hạn và công việc hợp đồng</div>
        <div class="article-content">
            <div class="list-item"><strong>-</strong> Loại hợp đồng lao động: Không xác định thời hạn.</div>
            <div class="list-item"><strong>-</strong> Từ ngày <span id="ngay-hieu-luc">...</span></div>
            <div class="list-item"><strong>-</strong> Địa điểm làm việc: Điều khiển xe <span id="loai-xe">...</span> biển số: <span id="bien-so">...</span></div>
            <div class="list-item"><strong>-</strong> Chức danh chuyên môn: Lái xe hạng <span id="hang-gplx">...</span></div>
            <div class="list-item"><strong>-</strong> Chức vụ: <span id="chuc-vu">...</span>.</div>
            <div class="list-item"><strong>-</strong> Công việc phải làm: Thực hiện theo sự điều động, phân công của HTX.</div>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 2. Chế độ làm việc</div>
        <div class="article-content">
            <p><strong>1. Thời gian làm việc chính thức:</strong></p>
            <p>08 giờ/ngày, từ Thứ 2 đến Thứ 7 hàng tuần.</p>
            <div class="list-item">- Buổi sáng: Từ 8 giờ 00 phút đến 12 giờ 00 phút.</div>
            <div class="list-item">- Buổi chiều: Từ 13 giờ 00 phút đến 17 giờ 00 phút.</div>
            <p style="margin-top: 10px;"><strong>2.</strong> Ngoài thời gian làm việc chính thức, theo quy định của Hợp tác xã, người lao động có thể được điều động đột xuất theo yêu cầu của Ban Giám đốc Hợp tác xã.</p>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 3. Nghĩa vụ và quyền lợi của người lao động</div>

        <div class="sub-section">
            <div class="sub-title">1. Quyền lợi:</div>
            
            <p><strong>1.1. Tiền lương và các khoản phụ cấp:</strong> Theo thỏa thuận.</p>
            
            <p style="margin-top: 10px;"><strong>1.2. Chế độ nâng lương:</strong></p>
            <div class="list-item">a) Thời điểm xét nâng lương: Năm năm xét 01(một) lần.</div>
            <div class="list-item">b) Thời điểm bắt đầu áp dụng mức lương mới: Vào ngày ra quyết định nâng lương.</div>
            <div class="list-item">c) Điều kiện xem xét nâng lương: Tùy tình hình hoạt động kinh doanh của Hợp tác xã và theo quyết định của Ban lãnh đạo, Hợp tác xã chỉ xem xét nâng lương cho người lao động hoàn thành tốt nhiệm vụ được giao, đã làm việc tại Hợp tác xã đủ thời gian quy định và không vi phạm kỷ luật và/hoặc không trong thời gian xử lý kỷ luật lao động hoặc những trường hợp đặc biệt sẽ được Ban lãnh đạo Hợp tác xã xem xét quyết định nâng lương trước thời hạn.</div>
            
            <p style="margin-top: 10px;"><strong>1.3. Khen thưởng:</strong> Tùy tình hình hoạt động kinh doanh của Hợp tác xã và theo quyết định của Ban lãnh đạo.</p>
            
            <p style="margin-top: 10px;"><strong>1.4. Hình thức trả lương:</strong> Chuyển khoản hoặc tiền mặt</p>
            
            <p style="margin-top: 10px;"><strong>1.5. Chế độ nghỉ ngơi:</strong></p>
            <div class="list-item">a) Nghỉ hàng tuần: Theo quy định của Hợp tác xã.</div>
            <div class="list-item">b) Nghỉ hàng năm: Người lao động được ký hợp đồng chính thức và có thâm niên công tác từ đủ 12 (mười hai) tháng trở lên sẽ được nghỉ 12 (mười hai) ngày phép trong năm và vẫn hưởng đầy đủ lương với điều kiện nghỉ phép không quá 02 (hai) ngày liên tiếp và mỗi tháng không quá 02 (hai) ngày phép.</div>
            <div class="list-item">c) Nghỉ ngày lễ: Các ngày Lễ, Tết theo quy định của Hợp tác xã và Nhà nước.</div>
            
            <p style="margin-top: 10px;"><strong>1.6. Chế độ bảo hiểm xã hội:</strong> Theo quy định của Hợp tác xã và Nhà nước.</p>
        </div>

        <div class="sub-section">
            <div class="sub-title">2. Nghĩa vụ:</div>
            <div class="list-item"><strong>2.1.</strong> Lái xe có trách nhiệm bảo quản, giữ gìn xe ô tô luôn sạch sẽ, sử dụng an toàn, đúng mục đích. Có trách nhiệm tuân thủ Luật giao thông hiện hành và các văn bản hướng dẫn thi hành, thực hiện lộ trình công tác với tinh thần trách nhiệm cao nhất.</div>
            <div class="list-item"><strong>2.2.</strong> Luôn thể hiện phẩm chất trung thực, thái độ phục vụ niềm nở, lịch sự, nhiệt tình, đảm bảo đáp ứng thời gian công tác khi được điều động đột xuất.</div>
            <div class="list-item"><strong>2.3.</strong> Hoàn thành những công việc đã cam kết trong hợp đồng lao động này và tất cả các nhiệm vụ trong phạm vi mô tả công việc.</div>
            <div class="list-item"><strong>2.5.</strong> Các nghĩa vụ khác theo quy định tại nội quy của hợp tác xã.</div>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 4. Nghĩa vụ và quyền hạn của người sử dụng lao động</div>

        <div class="sub-section">
            <div class="sub-title">1. Nghĩa vụ:</div>
            <div class="list-item">a) Bảo đảm việc làm và thực hiện đầy đủ những điều đã cam kết trong hợp đồng lao động.</div>
            <div class="list-item">b) Thanh toán đầy đủ, đúng hạn các chế độ và quyền lợi cho Người lao động theo hợp đồng lao động, nội quy lao động và thỏa thuận lao động tập thể (nếu có).</div>
        </div>

        <div class="sub-section">
            <div class="sub-title">2. Quyền hạn:</div>
            <div class="list-item">a) Giao nhiệm vụ và điều hành người lao động hoàn thành công việc theo hợp đồng lao động đã ký kết.</div>
            <div class="list-item">b) Có quyền điều chuyển tạm thời lao động, ngừng việc thay đổi, tạm hoãn, chấm dứt Hợp đồng lao động, áp dụng các hình thức xử lý kỷ luật, .... đối với người lao động theo nội quy của HTX, thỏa ước lao động tập thể (nếu có) và quy định của Pháp luật hiện hành.</div>
            <div class="list-item">c) Yêu cầu người lao động cung cấp mọi thông tin liên quan đến công việc của người lao động theo Hợp đồng này.</div>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 5. Chấm dứt hợp đồng lao động</div>
        <div class="article-content">
            <p><strong>1.</strong> Người lao động và người sử dụng lao động có quyền đơn phương chấm dứt hợp đồng lao động trước hạn và phải tuân thủ theo quy định của Bộ luật Lao động và các quy định của pháp luật hiện hành.</p>
            <p style="margin-top: 10px;"><strong>2.</strong> Trường hợp người lao động vi phạm nội quy hợp tác xã, vi phạm quy định của pháp luật thì HTX sẽ áp dụng hình thức kỷ luật sa thải theo quy định tại của Bộ luật Lao động và pháp luật hiện hành.</p>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 6. Thỏa thuận khác</div>
        <div class="article-content">
            <p><strong>1.</strong> Trong quá trình thực hiện hợp đồng nếu một bên có nhu cầu thay đổi nội dung trong Hợp đồng thì phải báo trước cho bên kia và ký kết bản Phụ lục Hợp đồng theo quy định của pháp luật. Trong thời gian tiến hành thỏa thuận hai Bên vẫn tuân thủ theo Hợp đồng lao động đã ký kết.</p>
            <p style="margin-top: 10px;"><strong>2.</strong> Người lao động đọc kỹ, hiểu rõ và cam kết thực hiện các điều khoản và quy định ghi tại Hợp đồng này.</p>
            <p style="margin-top: 10px;"><strong>3.</strong> Trường hợp xảy ra tranh chấp hai Bên sẽ cùng giải quyết thông qua thương lượng, hòa giải trong vòng 30 ngày kể từ ngày xảy ra tranh chấp đó. Nếu không thể hòa giải được, một trong hai Bên có quyền đưa vụ việc ra giải quyết tại Tòa án có thẩm quyền của Việt Nam.</p>
        </div>
    </div>

    <div class="article">
        <div class="article-title">Điều 7. Điều khoản thi hành</div>
        <div class="article-content">
            <p><strong>1.</strong> Những vấn đề về lao động không ghi trong Hợp đồng lao động này thì áp dụng theo Thỏa ước lao động tập thể (nếu có), nội quy lao động và pháp luật hiện hành.</p>
            <p style="margin-top: 10px;"><strong>2.</strong> Hợp đồng này được lập thành 02 (hai) bản có giá trị như nhau, Hành chính nhân sự giữ 01(một) bản, Người lao động giữ 01 (một) bản và có hiệu lực kể từ ngày ký kết hợp đồng.</p>
            <p style="margin-top: 10px;"><strong>3.</strong> Hợp đồng này được lập ngày <span id="ngay-footer">...</span> tháng <span id="thang-footer">...</span> năm <span id="nam-footer">...</span> tại trụ sở của Hợp tác xã vận tải Gia Linh.</p>
        </div>
    </div>

    <div class="signature-section">
        <div class="signature-left">
            <div class="signature-title">NGƯỜI LAO ĐỘNG</div>
            <div class="signature-name" id="ho-ten-signature">...</div>
        </div>
        <div class="signature-right">
            <div class="signature-title">NGƯỜI SỬ DỤNG LAO ĐỘNG</div>
            <div class="signature-name" id="nguoi-dai-dien-signature">...</div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = '4382b705-5dcf-4dfa-817a-55dd6173eafa';
        const accessKey = 'V2-huCGu-Kk2Rx-ysqBu-DpsaC-bmou2-9XklX-nHDzA-0KGsl';
        const region = 'www';

        // Biến toàn cục để lưu dữ liệu
        let globalContractData = null;

        // Function to get IDHoSo from URL
        function getIDHoSoFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('IDHoSo') || urlParams.get('idhoso');
        }

        // Function to fetch data from AppSheet
        async function fetchAppSheetData(tableName, filter = null) {
            try {
                const selector = filter || `Filter(${tableName}, true)`;
                console.log(`🔍 Executing selector for ${tableName}:`, selector);

                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: selector
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`🔍 Response for ${tableName}:`, data);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch ${tableName}:`, error);
                throw error;
            }
        }

        // Format date từ Date thành dd/mm/yyyy
        function formatDateShort(dateString) {
            if (!dateString || dateString === '') {
                return '';
            }

            let date;
            if (typeof dateString === 'string') {
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]);
                        const year = parseInt(parts[2]);
                        date = new Date(year, month - 1, day);
                    }
                } else if (dateString.includes('-')) {
                    date = new Date(dateString);
                } else {
                    date = new Date(dateString);
                }
            } else if (dateString instanceof Date) {
                date = dateString;
            } else {
                return dateString.toString();
            }

            if (isNaN(date.getTime())) {
                return dateString.toString();
            }

            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Format date đầy đủ cho ngày hiệu lực
        function formatDateFull(dateString) {
            console.log('🔍 formatDateFull input:', dateString, typeof dateString);

            if (!dateString || dateString === '') {
                return '';
            }

            let date;

            // AppSheet trả về MM/DD/YYYY format
            if (typeof dateString === 'string' && dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]);
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);

                    date = new Date(year, month - 1, day);
                    console.log('🔍 Parsed from MM/DD/YYYY:', `${month}/${day}/${year} → ${date}`);
                }
            } else {
                date = new Date(dateString);
            }

            if (!date || isNaN(date.getTime())) {
                console.log('❌ Invalid date:', dateString);
                return dateString.toString();
            }

            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            const result = `${day.toString().padStart(2, '0')} tháng ${month} năm ${year}`;
            console.log('✅ Final formatted:', result);

            return result;
        }

        // Get current date components
        function getCurrentDateComponents(ngayKy) {
            if (ngayKy) {
                try {
                    let date = null;

                    if (typeof ngayKy === 'string' && ngayKy.includes('/')) {
                        const parts = ngayKy.split('/');
                        if (parts.length === 3) {
                            const month = parseInt(parts[0], 10);
                            const day = parseInt(parts[1], 10);
                            const year = parseInt(parts[2], 10);
                            date = new Date(year, month - 1, day);
                        }
                    } else {
                        date = new Date(ngayKy);
                    }

                    if (date && !isNaN(date.getTime())) {
                        return {
                            day: date.getDate().toString().padStart(2, '0'),
                            month: date.getMonth() + 1,
                            year: date.getFullYear()
                        };
                    }
                } catch (e) {
                    console.warn('Không parse được NgayKy, sẽ dùng ngày hiện tại', e);
                }
            }

            const today = new Date();
            return {
                day: today.getDate().toString().padStart(2, '0'),
                month: today.getMonth() + 1,
                year: today.getFullYear()
            };
        }

        // Extract province from address
        function extractProvince(address) {
            if (!address) return 'Bắc Ninh';
            const provincePrefixes = ['Tỉnh ', 'Thành phố ', 'TP. ', 'T.P '];
            const parts = address.split(',');
            let lastPart = parts[parts.length - 1].trim();

            for (const prefix of provincePrefixes) {
                if (lastPart.startsWith(prefix)) {
                    lastPart = lastPart.substring(prefix.length).trim();
                    break;
                }
            }

            return lastPart || 'Bắc Ninh';
        }

        // Load data from AppSheet
        async function loadData() {
            try {
                const idHoSo = getIDHoSoFromURL();
                console.log('🔍 ID từ URL:', idHoSo);

                if (!idHoSo) {
                    throw new Error('Không tìm thấy IDHoSo trong URL');
                }

                const [hosoList, donviList, xeList, nhansuList] = await Promise.all([
                    fetchAppSheetData('HOSONHANSU', `Filter(HOSONHANSU, [IDHoSo] = "${idHoSo}")`),
                    fetchAppSheetData('THONGTINDONVI'),
                    fetchAppSheetData('THONGTINXE'),
                    fetchAppSheetData('THONGTINNHANSU')
                ]);

                if (!hosoList || hosoList.length === 0) {
                    throw new Error('Không tìm thấy hồ sơ với ID này');
                }

                const hosoData = hosoList.find(item => item.IDHoSo === idHoSo);
                if (!hosoData) {
                    throw new Error(`Không tìm thấy ID "${idHoSo}"`);
                }

                const donviData = donviList.length > 0 ? donviList[0] : {};
                const xeData = hosoData.Ref_Xe ?
                    xeList.find(x => x.Idxe === hosoData.Ref_Xe) || {} : {};
                const nhansuData = hosoData.Ref_ThanhVien ?
                    nhansuList.find(n => n.IDNS === hosoData.Ref_ThanhVien) || {} : {};

                const currentDate = getCurrentDateComponents(hosoData.NgayKy);

                // Lưu dữ liệu cho xuất Word
                globalContractData = {
                    IDHoSo: hosoData.IDHoSo || '',
                    SoVanBan: hosoData.SoVanBan || '',
                    Tendonvi: donviData.Tendonvi || '',
                    Tendonvi_Uper: (donviData.Tendonvi || '').toUpperCase(),
                    Nguoidaidien: donviData.Nguoidaidien || '',
                    ChucvuNguoidaidien: donviData.ChucvuNguoidaidien || '',
                    Hoten: nhansuData.Hoten || '',
                    Hoten_Uper: (nhansuData.Hoten || '').toUpperCase(),
                    Ngaysinh: formatDateShort(nhansuData.Ngaysinh),
                    SoCCCD: nhansuData.NoCCCD || '',
                    NgayCapCCCD: formatDateShort(nhansuData.NgayCapCCCD),
                    NoicapCCCD: nhansuData.NoicapCCCD || 'Cục Cảnh sát ĐKQL cư trú và DLQG về dân cư',
                    SoGPLX: nhansuData.SoGPLX || '',
                    Diachi: donviData.Diachi || '',
                    Diachidaydu: nhansuData.Diachidaydu || '',
                    Loaixe: xeData.Loaixe || '',
                    Bienso: xeData.Bienso || '',
                    SoDT: donviData.SoDT || '',
                    HangGPLX: nhansuData['Hạng GPLX'] || '',
                    Chucvu: nhansuData.Chucvu || '',
                    NgayHieuLuc_dai: formatDateFull(hosoData.NgayHieuLuc || ''),
                    Tinh: extractProvince(nhansuData.Diachidaydu),
                    Ngay: currentDate.day,
                    Thang: currentDate.month === 1 || currentDate.month === 2 ?
                        currentDate.month.toString().padStart(2, '0') : currentDate.month.toString(),
                    Nam: currentDate.year
                };

                populateHTML(globalContractData);
                hideLoadingMessage();

            } catch (error) {
                console.error('Error loading data:', error);
                hideLoadingMessage();
                alert('Lỗi: ' + error.message);
            }
        }

        // Populate HTML with data
        function populateHTML(data) {
            const setText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || '';
                }
            };

            setText('ten-don-vi-upper', data.Tendonvi_Uper);
            setText('so-van-ban', data.SoVanBan);
            setText('tinh', data.Tinh);
            setText('ngay', data.Ngay);
            setText('thang', data.Thang);
            setText('nam', data.Nam);
            setText('ten-don-vi-a', data.Tendonvi_Uper);
            setText('dia-chi-don-vi', data.Diachi);
            setText('so-dt', data.SoDT);
            setText('nguoi-dai-dien', data.Nguoidaidien);
            setText('chuc-vu-nguoi-dai-dien', data.ChucvuNguoidaidien);
            setText('ho-ten-upper', data.Hoten_Uper);
            setText('ngay-sinh', data.Ngaysinh);
            setText('dia-chi-nhan-su', data.Diachidaydu);
            setText('so-cccd', data.SoCCCD);
            setText('ngay-cap-cccd', data.NgayCapCCCD);
            setText('noi-cap-cccd', data.NoicapCCCD);
            setText('ngay-hieu-luc', data.NgayHieuLuc_dai);
            setText('loai-xe', data.Loaixe);
            setText('bien-so', data.Bienso);
            setText('hang-gplx', data.HangGPLX);
            setText('chuc-vu', data.Chucvu);
            setText('ngay-footer', data.Ngay);
            setText('thang-footer', data.Thang);
            setText('nam-footer', data.Nam);
            setText('ho-ten-signature', data.Hoten);
            setText('nguoi-dai-dien-signature', data.Nguoidaidien);
        }

        // Export to Word template
        async function exportToWordTemplate() {
            try {
                if (!globalContractData) {
                    alert('Dữ liệu chưa được tải. Vui lòng đợi dữ liệu tải xong.');
                    return;
                }

                document.getElementById('loading-message').style.display = 'block';
                document.getElementById('loading-message').textContent = 'Đang xuất file Word...';

                const templateUrl = 'https://poalninh.github.io/templates/templates/hdld_gialinh_template.docx';

                const response = await fetch(templateUrl);
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }

                const templateContent = await response.arrayBuffer();
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                doc.setData(globalContractData);
                doc.render();
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `HopDongLaoDong_${globalContractData.Hoten || 'Document'}.docx`;
                saveAs(blob, fileName);

                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi xuất file Word:', error);
                alert('Có lỗi xảy ra khi xuất file Word: ' + error.message);
                hideLoadingMessage();
            }
        }

        // Hide loading message
        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Initialize application
        async function initialize() {
            try {
                const idHoSo = getIDHoSoFromURL();
                if (!idHoSo) {
                    alert('Vui lòng cung cấp IDHoSo trong URL. Ví dụ: ?IDHoSo=HS001');
                    return;
                }
                await loadData();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Không thể kết nối với hệ thống. Vui lòng thử lại sau.');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                initialize();
            }, 500);
        });

        // Disable right-click and F12
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>