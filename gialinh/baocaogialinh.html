<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTX VẬN TẢI GIA LINH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for better tab highlighting */
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            background-color: #eff6ff;
            font-weight: 600;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #2563eb;
            border-radius: 2px 2px 0 0;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-2 rounded-full shadow-md">
                        <i class="fas fa-bus text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">HTX VẬN TẢI GIA LINH</h1>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button id="refreshBtn"
                        class="bg-white text-blue-600 px-4 py-2 rounded-md hover:bg-blue-50 shadow-md transition duration-200 flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span class="hidden sm:inline">Làm mới</span>
                    </button>
                    <button id="exportBtn"
                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 shadow-md transition duration-200 flex items-center space-x-2">
                        <i class="fas fa-file-excel"></i>
                        <span class="hidden sm:inline">Xuất Excel</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="bg-white rounded-lg shadow">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                    <button id="tabPhuHieu"
                        class="tab-button active border-blue-500 text-blue-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('phuHieu')">
                        <i class="fas fa-id-card mr-2"></i>Phù Hiệu
                    </button>
                    <button id="tabGPLX"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('gplx')">
                        <i class="fas fa-address-card mr-2"></i>GPLX
                    </button>
                    <button id="tabNhanSu"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('nhanSu')">
                        <i class="fas fa-users mr-2"></i>Nhân Sự
                    </button>
                    <button id="tabDangKiem"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('dangKiem')">
                        <i class="fas fa-clipboard-check mr-2"></i>Đăng Kiểm
                    </button>
                    <button id="tabTapHuan"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('tapHuan')">
                        <i class="fas fa-graduation-cap mr-2"></i>Tập Huấn
                    </button>
                    <button id="tabSucKhoe"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm"
                        onclick="switchTab('sucKhoe')">
                        <i class="fas fa-heartbeat mr-2"></i>Sức Khỏe
                    </button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Content Areas -->
    <main class="max-w-7xl mx-auto px-4 pb-6">
        <!-- Phù Hiệu Tab Content -->
        <div id="phuHieuContent" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-id-card text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng phù hiệu</p>
                            <p class="text-xl font-semibold" id="totalCountPH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Còn hiệu lực</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountPH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Sắp hết hạn</p>
                            <p class="text-xl font-semibold text-yellow-600" id="expiringCountPH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-times-circle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Hết hiệu lực</p>
                            <p class="text-xl font-semibold text-red-600" id="expiredCountPH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-orange-100 rounded-full">
                            <i class="fas fa-ban text-orange-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Bị thu hồi</p>
                            <p class="text-xl font-semibold text-orange-600" id="revokedCountPH">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputPH" placeholder="Tìm kiếm theo số phù hiệu, biển số xe..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnPH" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc phù hiệu</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại phù hiệu</label>
                        <select id="typeFilterPH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterPH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                            <option value="Còn hiệu lực">Còn hiệu lực</option>
                            <option value="Hết hiệu lực">Hết hiệu lực</option>
                            <option value="Bị thu hồi">Bị thu hồi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" id="fromDatePH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" id="toDatePH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterPH" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterPH" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái phù hiệu</h3>
                    <div class="h-80">
                        <canvas id="statusChartPH"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Phân loại phù hiệu</h3>
                    <div class="h-64">
                        <canvas id="typeChartPH"></canvas>
                    </div>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Xu hướng cấp phù hiệu theo tháng</h3>
                <div class="h-64">
                    <canvas id="trendChartPH"></canvas>
                </div>
            </div>

            <!-- Data Table Phù Hiệu -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách phù hiệu</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPagePH" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingPH" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerPH" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'PH')">
                                    STT <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('SoPH', 'PH')">
                                    Số phù hiệu <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Loaiphuhieu', 'PH')">
                                    Loại phù hiệu <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Biển số xe
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tuyến</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngaycap', 'PH')">
                                    Ngày cấp <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngayhethan', 'PH')">
                                    Ngày hết hạn <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('TrangthaiPH', 'PH')">
                                    Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyPH" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobilePH"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Trước
                        </button>
                        <button id="nextPageMobilePH"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Sau
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemPH" class="font-medium">1</span> đến <span id="toItemPH"
                                    class="font-medium">10</span>
                                của <span id="totalItemsPH" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationPH">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorPH" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>

        <!-- GPLX Tab Content -->
        <div id="gplxContent" class="tab-content hidden">
            <!-- Stats Cards GPLX -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-address-card text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng GPLX</p>
                            <p class="text-xl font-semibold" id="totalCountGPLX">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Còn hiệu lực</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountGPLX">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Sắp hết hạn</p>
                            <p class="text-xl font-semibold text-yellow-600" id="expiringCountGPLX">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-times-circle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Hết hiệu lực</p>
                            <p class="text-xl font-semibold text-red-600" id="expiredCountGPLX">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-gray-100 rounded-full">
                            <i class="fas fa-question-circle text-gray-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Chưa xác định</p>
                            <p class="text-xl font-semibold text-gray-600" id="suspendedCountGPLX">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search GPLX -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputGPLX" placeholder="Tìm kiếm theo số GPLX, họ tên lái xe..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnGPLX" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters GPLX -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc GPLX</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hạng GPLX</label>
                        <select id="hangFilterGPLX"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cơ quan cấp</label>
                        <select id="coQuanCapFilterGPLX"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterGPLX"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" id="fromDateGPLX"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" id="toDateGPLX"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterGPLX" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterGPLX" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row GPLX -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái GPLX</h3>
                    <div class="h-80">
                        <canvas id="statusChartGPLX"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Phân loại hạng GPLX</h3>
                    <div class="h-64">
                        <canvas id="hangChartGPLX"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table GPLX -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách giấy phép lái xe</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPageGPLX" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingGPLX" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerGPLX" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'GPLX')">
                                    STT <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('soGPLX', 'GPLX')">
                                    Số GPLX <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hoten', 'GPLX')">
                                    Họ tên <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hang', 'GPLX')">
                                    Hạng <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngaysinh', 'GPLX')">
                                    Ngày sinh <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngaycap', 'GPLX')">
                                    Ngày cấp <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngayhethan', 'GPLX')">
                                    Ngày hết hạn <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Coquancap', 'GPLX')">
                                    Cơ quan cấp <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Trangthai', 'GPLX')">
                                    Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyGPLX" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobileGPLX"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Trước
                        </button>
                        <button id="nextPageMobileGPLX"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Sau
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemGPLX" class="font-medium">1</span> đến <span id="toItemGPLX"
                                    class="font-medium">10</span>
                                của <span id="totalItemsGPLX" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationGPLX">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorGPLX" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>

        <!-- Nhân Sự Tab Content -->
        <div id="nhanSuContent" class="tab-content hidden">
            <!-- Stats Cards Nhân Sự -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-users text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng nhân sự</p>
                            <p class="text-xl font-semibold" id="totalCountNS">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-user-check text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Đang làm việc</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountNS">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-user-times text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Đã nghỉ việc</p>
                            <p class="text-xl font-semibold text-red-600" id="pausedCountNS">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-full">
                            <i class="fas fa-user-tie text-purple-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Nam</p>
                            <p class="text-xl font-semibold text-purple-600" id="maleCountNS">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-pink-100 rounded-full">
                            <i class="fas fa-user text-pink-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Nữ</p>
                            <p class="text-xl font-semibold text-pink-600" id="inactiveCountNS">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Nhân Sự -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputNS" placeholder="Tìm kiếm theo họ tên, CCCD, số điện thoại..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnNS" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters Nhân Sự -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc nhân sự</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chức vụ</label>
                        <select id="chucVuFilterNS"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Giới tính</label>
                        <select id="genderFilterNS"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trình độ</label>
                        <select id="trinhDoFilterNS"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterNS"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tỉnh/Thành phố</label>
                        <select id="tinhFilterNS"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterNS" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterNS" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row Nhân Sự -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái nhân sự</h3>
                    <div class="h-80">
                        <canvas id="statusChartNS"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Phân loại chức vụ</h3>
                    <div class="h-64">
                        <canvas id="chucVuChartNS"></canvas>
                    </div>
                </div>
            </div>

            <!-- Gender & Education Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Giới tính</h3>
                    <div class="h-64">
                        <canvas id="genderChartNS"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Trình độ</h3>
                    <div class="h-64">
                        <canvas id="educationChartNS"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table Nhân Sự -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách nhân sự</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPageNS" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingNS" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerNS" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'NS')">
                                    STT <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('IDNS', 'NS')">
                                    Mã NV <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hoten', 'NS')">
                                    Họ tên <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngaysinh', 'NS')">
                                    Ngày sinh <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giới tính
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chức vụ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trình độ
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số điện
                                    thoại</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Trangthai', 'NS')">
                                    Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyNS" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobileNS"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Trước
                        </button>
                        <button id="nextPageMobileNS"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Sau
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemNS" class="font-medium">1</span> đến <span id="toItemNS"
                                    class="font-medium">10</span>
                                của <span id="totalItemsNS" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationNS">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorNS" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>

        <!-- Đăng Kiểm Tab Content -->
        <div id="dangKiemContent" class="tab-content hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-clipboard-check text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng đăng kiểm</p>
                            <p class="text-xl font-semibold" id="totalCountDK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Còn hiệu lực</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountDK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Sắp hết hạn</p>
                            <p class="text-xl font-semibold text-yellow-600" id="expiringCountDK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-times-circle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Hết hạn</p>
                            <p class="text-xl font-semibold text-red-600" id="expiredCountDK">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputDK"
                            placeholder="Tìm kiếm theo biển số xe, cơ quan đăng kiểm..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnDK" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc đăng kiểm</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cơ quan đăng kiểm</label>
                        <select id="coQuanFilterDK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterDK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" id="fromDateDK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" id="toDateDK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterDK" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterDK" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái đăng kiểm</h3>
                    <div class="h-80">
                        <canvas id="statusChartDK"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Cơ quan đăng kiểm</h3>
                    <div class="h-64">
                        <canvas id="coQuanChartDK"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách đăng kiểm</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPageDK" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingDK" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerDK" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'DK')">STT <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ID_KiemDinh', 'DK')">Mã đăng kiểm <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Biển số xe
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngaydangkiem', 'DK')">Ngày đăng kiểm <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Ngayhethan', 'DK')">Ngày hết hạn <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cơ quan ĐK
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Trangthai', 'DK')">Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyDK" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobileDK"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Trước</button>
                        <button id="nextPageMobileDK"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Sau</button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemDK" class="font-medium">1</span> đến <span id="toItemDK"
                                    class="font-medium">10</span>
                                của <span id="totalItemsDK" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationDK">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorDK" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>

        <!-- Tập Huấn Tab Content -->
        <div id="tapHuanContent" class="tab-content hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-graduation-cap text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng chứng nhận</p>
                            <p class="text-xl font-semibold" id="totalCountTH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Còn hiệu lực</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountTH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Sắp hết hạn</p>
                            <p class="text-xl font-semibold text-yellow-600" id="expiringCountTH">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-times-circle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Hết hiệu lực</p>
                            <p class="text-xl font-semibold text-red-600" id="expiredCountTH">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputTH" placeholder="Tìm kiếm theo họ tên, số GCN..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnTH" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc tập huấn</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chương trình</label>
                        <select id="chuongTrinhFilterTH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đơn vị tổ chức</label>
                        <select id="donViFilterTH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterTH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" id="fromDateTH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" id="toDateTH"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterTH" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterTH" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái tập huấn</h3>
                    <div class="h-80">
                        <canvas id="statusChartTH"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Chương trình đào tạo</h3>
                    <div class="h-64">
                        <canvas id="chuongTrinhChartTH"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách tập huấn</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPageTH" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingTH" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerTH" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'TH')">STT <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ID_DT', 'TH')">Mã đào tạo <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hoten', 'TH')">Họ tên <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chương trình
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ThoiGianToChuc_Tungay', 'TH')">Từ ngày <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ThoiGianToChuc_Denngay', 'TH')">Đến ngày <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số GCN</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ThoiHanGCN', 'TH')">Thời hạn GCN <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('HieulucGCN', 'TH')">Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyTH" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobileTH"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Trước</button>
                        <button id="nextPageMobileTH"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Sau</button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemTH" class="font-medium">1</span> đến <span id="toItemTH"
                                    class="font-medium">10</span>
                                của <span id="totalItemsTH" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationTH">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorTH" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>

        <!-- Sức Khỏe Tab Content -->
        <div id="sucKhoeContent" class="tab-content hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-full">
                            <i class="fas fa-heartbeat text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Tổng giấy khám</p>
                            <p class="text-xl font-semibold" id="totalCountSK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Còn hiệu lực</p>
                            <p class="text-xl font-semibold text-green-600" id="activeCountSK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-full">
                            <i class="fas fa-clock text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Sắp hết hạn</p>
                            <p class="text-xl font-semibold text-yellow-600" id="expiringCountSK">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="p-2 bg-red-100 rounded-full">
                            <i class="fas fa-times-circle text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">Hết hiệu lực</p>
                            <p class="text-xl font-semibold text-red-600" id="expiredCountSK">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input type="text" id="searchInputSK" placeholder="Tìm kiếm theo họ tên, cơ sở y tế..."
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="searchBtnSK" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bộ lọc sức khỏe</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cơ sở y tế</label>
                        <select id="coSoYTeFilterSK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kết quả</label>
                        <select id="ketQuaFilterSK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select id="statusFilterSK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" id="fromDateSK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" id="toDateSK"
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="applyFilterSK" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Áp dụng
                    </button>
                    <button id="clearFilterSK" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>Xóa lọc
                    </button>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Biểu đồ trạng thái sức khỏe</h3>
                    <div class="h-80">
                        <canvas id="statusChartSK"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Kết quả khám</h3>
                    <div class="h-64">
                        <canvas id="ketQuaChartSK"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Danh sách khám sức khỏe</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Hiển thị:</span>
                        <select id="itemsPerPageSK" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">mục/trang</span>
                    </div>
                </div>

                <div id="loadingSK" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải dữ liệu...</p>
                </div>

                <div id="tableContainerSK" class="hidden overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('stt', 'SK')">STT <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ID_SK', 'SK')">Mã khám <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hoten', 'SK')">Họ tên <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ThoiGianKiemTra', 'SK')">Ngày khám <i
                                        class="fas fa-sort ml-1"></i></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('ThoihanGKSK', 'SK')">Thời hạn <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cơ sở y tế
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kết quả</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                    onclick="sortTable('Hieuluc', 'SK')">Trạng thái <i class="fas fa-sort ml-1"></i>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodySK" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>

                <div class="bg-white px-6 py-3 flex items-center justify-between border-t border-gray-200">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobileSK"
                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Trước</button>
                        <button id="nextPageMobileSK"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Sau</button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Hiển thị <span id="fromItemSK" class="font-medium">1</span> đến <span id="toItemSK"
                                    class="font-medium">10</span>
                                của <span id="totalItemsSK" class="font-medium">0</span> kết quả
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationSK">
                            </nav>
                        </div>
                    </div>
                </div>

                <div id="errorSK" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    <p class="mt-2 text-gray-600">Không thể tải dữ liệu. Vui lòng thử lại.</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_URL: 'https://api.appsheet.com/api/v2/apps/4382b705-5dcf-4dfa-817a-55dd6173eafa/tables',
            ACCESS_KEY: 'V2-huCGu-Kk2Rx-ysqBu-DpsaC-bmou2-9XklX-nHDzA-0KGsl',
            REFRESH_INTERVAL: 5 * 60 * 1000,
            DEBOUNCE_DELAY: 300
        };

        // ============================================
        // GLOBAL STATE
        // ============================================
        const state = {
            currentTab: 'phuHieu',
            PH: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} },
            GPLX: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} },
            NS: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} },
            DK: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} },
            TH: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} },
            SK: { allData: [], filteredData: [], currentPage: 1, itemsPerPage: 10, sortColumn: '', sortDirection: 'asc', charts: {} }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func(...args), delay);
            };
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                // Tháng 1, 2: có số 0 đằng trước
                // Tháng 3-12: không có số 0 đằng trước
                const monthStr = month <= 2 ? String(month).padStart(2, '0') : String(month);

                return `${day}/${monthStr}/${year}`;
            } catch {
                return dateString;
            }
        };

        // ============================================
        // API FUNCTIONS
        // ============================================
        async function apiRequest(tableName, action, data = {}) {
            try {
                console.log(`API Request: ${tableName} - ${action}`);
                const response = await fetch(`${CONFIG.API_URL}/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': CONFIG.ACCESS_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        Properties: {
                            Locale: 'vi-VN',
                            Timezone: 'Asia/Ho_Chi_Minh'
                        },
                        ...data
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                console.log(`API Response: ${tableName}`, result);
                return result;
            } catch (error) {
                console.error(`API Error: ${tableName}`, error);
                throw error;
            }
        }

        // ============================================
        // DATA LOADING FUNCTIONS
        // ============================================
        async function loadDataPH() {
            showLoading('PH');
            try {
                const [phuHieu, xe, tuyen] = await Promise.all([
                    apiRequest('THONGTINPHUHIEU', 'Find'),
                    apiRequest('THONGTINXE', 'Find'),
                    apiRequest('DANHMUCTUYENCODINH', 'Find')
                ]);

                const xeMap = new Map(xe.map(item => [item.Idxe, item]));
                const tuyenMap = new Map();
                tuyen.forEach(item => {
                    if (item.MaSoTuyen) tuyenMap.set(item.MaSoTuyen, item);
                    tuyenMap.set(item.id, item);
                });

                state.PH.allData = phuHieu.map(item => {
                    const xeData = xeMap.get(item.Refxe) || {};
                    const tuyenData = tuyenMap.get(item.RefTuyenCD) || {};
                    const result = {
                        ...item,
                        BienSoXe: xeData.Bienso || '',
                        NhanHieuXe: xeData.Nhanhieu || '',
                        LoaiXe: xeData.Loaixe || '',
                        TenTuyen: tuyenData['Tên tuyến'] || tuyenData.TenTuyen || ''
                    };

                    if (result.Ngayhethan && result.TrangthaiPH === 'Còn hiệu lực') {
                        const daysToExpire = Math.ceil((new Date(result.Ngayhethan) - new Date()) / (1000 * 60 * 60 * 24));
                        result.isExpiring = daysToExpire <= 30 && daysToExpire > 0;
                    }
                    return result;
                });

                if (state.PH.allData.length === 0) {
                    showError('PH');
                    return;
                }

                state.PH.filteredData = [...state.PH.allData];
                updateStatsPH();
                updateChartsPH();
                updateFiltersPH();
                renderTablePH();
                showTable('PH');

                console.log('Loaded PH:', state.PH.allData.length);
            } catch (error) {
                console.error('Error loading PH:', error);
                showError('PH');
            }
        }

        async function loadDataGPLX() {
            showLoading('GPLX');
            try {
                const [gplx, nhanSu] = await Promise.all([
                    apiRequest('THONGTINGPLX', 'Find'),
                    apiRequest('THONGTINNHANSU', 'Find')
                ]);

                const nsMap = new Map(nhanSu.map(item => [item.IDNS, item]));
                const today = new Date();

                state.GPLX.allData = gplx.map(item => {
                    const ns = nsMap.get(item.RefNhansu) || {};
                    const result = {
                        ...item,
                        Hoten: ns.Hoten || item.Scan_Hoten || '',
                        Gioitinh: ns.Gioitinh || ''
                    };

                    if (!result.Ngayhethan) {
                        result.Trangthai = 'Chưa xác định';
                    } else {
                        const daysToExpire = Math.ceil((new Date(result.Ngayhethan) - today) / (1000 * 60 * 60 * 24));
                        if (daysToExpire < 0) result.Trangthai = 'Hết hạn';
                        else if (daysToExpire <= 30) result.Trangthai = 'Sắp hết hạn';
                        else result.Trangthai = 'Còn hiệu lực';
                    }
                    return result;
                });

                if (state.GPLX.allData.length === 0) {
                    showError('GPLX');
                    return;
                }

                state.GPLX.filteredData = [...state.GPLX.allData];
                updateStatsGPLX();
                updateChartsGPLX();
                updateFiltersGPLX();
                renderTableGPLX();
                showTable('GPLX');

                console.log('Loaded GPLX:', state.GPLX.allData.length);
            } catch (error) {
                console.error('Error loading GPLX:', error);
                showError('GPLX');
            }
        }

        async function loadDataNS() {
            showLoading('NS');
            try {
                const nhanSu = await apiRequest('THONGTINNHANSU', 'Find');

                state.NS.allData = nhanSu.map(item => ({
                    ...item,
                    Trangthai: item.Trangthai || 'Đang làm việc'
                }));

                if (state.NS.allData.length === 0) {
                    showError('NS');
                    return;
                }

                state.NS.filteredData = [...state.NS.allData];
                updateStatsNS();
                updateChartsNS();
                updateFiltersNS();
                renderTableNS();
                showTable('NS');

                console.log('Loaded NS:', state.NS.allData.length);
            } catch (error) {
                console.error('Error loading NS:', error);
                showError('NS');
            }
        }

        async function loadDataDK() {
            showLoading('DK');
            try {
                const [dangKiem, xe] = await Promise.all([
                    apiRequest('THONGTINDANGKIEM', 'Find'),
                    apiRequest('THONGTINXE', 'Find')
                ]);

                const xeMap = new Map(xe.map(item => [item.Idxe, item]));
                const today = new Date();

                state.DK.allData = dangKiem.map(item => {
                    const xeData = xeMap.get(item.Refxe) || {};
                    const result = {
                        ...item,
                        BienSoXe: xeData.Bienso || '',
                        NhanHieuXe: xeData.Nhanhieu || '',
                        LoaiXe: xeData.Loaixe || ''
                    };

                    // Tính trạng thái dựa trên Ngayhethan
                    if (!result.Ngayhethan) {
                        result.Trangthai = 'Chưa đăng kiểm';
                    } else {
                        const daysToExpire = Math.ceil((new Date(result.Ngayhethan) - today) / (1000 * 60 * 60 * 24));
                        if (daysToExpire < 0) result.Trangthai = 'Hết hạn';
                        else if (daysToExpire <= 30) result.Trangthai = 'Sắp hết hạn';
                        else result.Trangthai = 'Còn hiệu lực';
                    }
                    return result;
                });

                if (state.DK.allData.length === 0) {
                    showError('DK');
                    return;
                }

                state.DK.filteredData = [...state.DK.allData];
                updateStatsDK();
                updateChartsDK();
                updateFiltersDK();
                renderTableDK();
                showTable('DK');

                console.log('Loaded DK:', state.DK.allData.length);
            } catch (error) {
                console.error('Error loading DK:', error);
                showError('DK');
            }
        }

        async function loadDataTH() {
            showLoading('TH');
            try {
                const [tapHuan, nhanSu] = await Promise.all([
                    apiRequest('DAOTAO_TAPHUAN_LX', 'Find'),
                    apiRequest('THONGTINNHANSU', 'Find')
                ]);

                const nsMap = new Map(nhanSu.map(item => [item.IDNS, item]));
                const today = new Date();

                state.TH.allData = tapHuan.map(item => {
                    const ns = nsMap.get(item.Ref_LaiXe) || {};
                    const result = {
                        ...item,
                        Hoten: ns.Hoten || ''
                    };

                    // Trạng thái từ cột HieulucGCN, nếu không có thì tính dựa trên ThoiHanGCN
                    if (result.HieulucGCN) {
                        result.HieulucGCN = result.HieulucGCN;
                    } else if (!result.ThoiHanGCN) {
                        result.HieulucGCN = 'Chưa có';
                    } else {
                        const daysToExpire = Math.ceil((new Date(result.ThoiHanGCN) - today) / (1000 * 60 * 60 * 24));
                        if (daysToExpire < 0) result.HieulucGCN = 'Hết hiệu lực';
                        else if (daysToExpire <= 30) result.HieulucGCN = 'Sắp hết hạn';
                        else result.HieulucGCN = 'Còn hiệu lực';
                    }
                    return result;
                });

                if (state.TH.allData.length === 0) {
                    showError('TH');
                    return;
                }

                state.TH.filteredData = [...state.TH.allData];
                updateStatsTH();
                updateChartsTH();
                updateFiltersTH();
                renderTableTH();
                showTable('TH');

                console.log('Loaded TH:', state.TH.allData.length);
            } catch (error) {
                console.error('Error loading TH:', error);
                showError('TH');
            }
        }

        async function loadDataSK() {
            showLoading('SK');
            try {
                const [sucKhoe, nhanSu] = await Promise.all([
                    apiRequest('THEODOISUCKHOE_LX', 'Find'),
                    apiRequest('THONGTINNHANSU', 'Find')
                ]);

                const nsMap = new Map(nhanSu.map(item => [item.IDNS, item]));
                const today = new Date();

                state.SK.allData = sucKhoe.map(item => {
                    const ns = nsMap.get(item.Ref_LaiXe) || {};
                    const result = {
                        ...item,
                        Hoten: ns.Hoten || ''
                    };

                    // Trạng thái từ cột Hieuluc, nếu không có thì tính dựa trên ThoihanGKSK
                    if (result.Hieuluc) {
                        result.Hieuluc = result.Hieuluc;
                    } else if (!result.ThoihanGKSK) {
                        result.Hieuluc = 'Chưa có hạn';
                    } else {
                        const daysToExpire = Math.ceil((new Date(result.ThoihanGKSK) - today) / (1000 * 60 * 60 * 24));
                        if (daysToExpire < 0) result.Hieuluc = 'Hết hiệu lực';
                        else if (daysToExpire <= 30) result.Hieuluc = 'Sắp hết hạn';
                        else result.Hieuluc = 'Còn hiệu lực';
                    }
                    return result;
                });

                if (state.SK.allData.length === 0) {
                    showError('SK');
                    return;
                }

                state.SK.filteredData = [...state.SK.allData];
                updateStatsSK();
                updateChartsSK();
                updateFiltersSK();
                renderTableSK();
                showTable('SK');

                console.log('Loaded SK:', state.SK.allData.length);
            } catch (error) {
                console.error('Error loading SK:', error);
                showError('SK');
            }
        }

        // ============================================
        // UI STATE FUNCTIONS
        // ============================================
        function showLoading(type) {
            document.getElementById(`loading${type}`).classList.remove('hidden');
            document.getElementById(`tableContainer${type}`).classList.add('hidden');
            document.getElementById(`error${type}`).classList.add('hidden');
        }

        function showTable(type) {
            document.getElementById(`loading${type}`).classList.add('hidden');
            document.getElementById(`tableContainer${type}`).classList.remove('hidden');
            document.getElementById(`error${type}`).classList.add('hidden');
        }

        function showError(type) {
            document.getElementById(`loading${type}`).classList.add('hidden');
            document.getElementById(`tableContainer${type}`).classList.add('hidden');
            const errorDiv = document.getElementById(`error${type}`);
            errorDiv.classList.remove('hidden');
            errorDiv.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                <p class="mt-2 text-gray-600">Không thể kết nối đến API hoặc không có dữ liệu.</p>
                <button onclick="loadData${type}()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Thử lại</button>
            </div>
        `;
        }

        // ============================================
        // STATISTICS UPDATE
        // ============================================
        function updateStatsPH() {
            const data = state.PH.filteredData;
            document.getElementById('totalCountPH').textContent = data.length;
            document.getElementById('activeCountPH').textContent = data.filter(i => i.TrangthaiPH === 'Còn hiệu lực' && !i.isExpiring).length;
            document.getElementById('expiringCountPH').textContent = data.filter(i => i.isExpiring).length;
            document.getElementById('expiredCountPH').textContent = data.filter(i => i.TrangthaiPH === 'Hết hiệu lực').length;
            document.getElementById('revokedCountPH').textContent = data.filter(i => i.TrangthaiPH === 'Bị thu hồi').length;
        }

        function updateStatsGPLX() {
            const data = state.GPLX.filteredData;
            document.getElementById('totalCountGPLX').textContent = data.length;
            document.getElementById('activeCountGPLX').textContent = data.filter(i => i.Trangthai === 'Còn hiệu lực').length;
            document.getElementById('expiringCountGPLX').textContent = data.filter(i => i.Trangthai === 'Sắp hết hạn').length;
            document.getElementById('expiredCountGPLX').textContent = data.filter(i => i.Trangthai === 'Hết hạn').length;
            document.getElementById('suspendedCountGPLX').textContent = data.filter(i => i.Trangthai === 'Chưa xác định').length;
        }

        function updateStatsNS() {
            const data = state.NS.filteredData;
            document.getElementById('totalCountNS').textContent = data.length;
            document.getElementById('activeCountNS').textContent = data.filter(i => i.Trangthai === 'Đang làm việc').length;
            document.getElementById('pausedCountNS').textContent = data.filter(i => i.Trangthai === 'Đã nghỉ việc').length;
            document.getElementById('maleCountNS').textContent = data.filter(i => i.Gioitinh === 'Nam').length;
            document.getElementById('inactiveCountNS').textContent = data.filter(i => i.Gioitinh === 'Nữ').length;
        }

        function updateStatsDK() {
            const data = state.DK.filteredData;
            document.getElementById('totalCountDK').textContent = data.length;
            document.getElementById('activeCountDK').textContent = data.filter(i => i.Trangthai === 'Còn hiệu lực').length;
            document.getElementById('expiringCountDK').textContent = data.filter(i => i.Trangthai === 'Sắp hết hạn').length;
            document.getElementById('expiredCountDK').textContent = data.filter(i => i.Trangthai === 'Hết hạn').length;
        }

        function updateStatsTH() {
            const data = state.TH.filteredData;
            document.getElementById('totalCountTH').textContent = data.length;
            document.getElementById('activeCountTH').textContent = data.filter(i => i.HieulucGCN === 'Còn hiệu lực').length;
            document.getElementById('expiringCountTH').textContent = data.filter(i => i.HieulucGCN === 'Sắp hết hạn').length;
            document.getElementById('expiredCountTH').textContent = data.filter(i => i.HieulucGCN === 'Hết hiệu lực').length;
        }

        function updateStatsSK() {
            const data = state.SK.filteredData;
            document.getElementById('totalCountSK').textContent = data.length;
            document.getElementById('activeCountSK').textContent = data.filter(i => i.Hieuluc === 'Còn hiệu lực').length;
            document.getElementById('expiringCountSK').textContent = data.filter(i => i.Hieuluc === 'Sắp hết hạn').length;
            document.getElementById('expiredCountSK').textContent = data.filter(i => i.Hieuluc === 'Hết hiệu lực').length;
        }

        // ============================================
        // CHART HELPER FUNCTIONS
        // ============================================
        function createDoughnutChart(ctx, labels, data, colors) {
            const filtered = labels.reduce((acc, label, i) => {
                if (data[i] > 0) {
                    acc.labels.push(label);
                    acc.data.push(data[i]);
                    acc.colors.push(colors[i]);
                }
                return acc;
            }, { labels: [], data: [], colors: [] });

            if (filtered.labels.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Không có dữ liệu', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return null;
            }

            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filtered.labels,
                    datasets: [{
                        data: filtered.data,
                        backgroundColor: filtered.colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    layout: { padding: { top: 60, bottom: 60, left: 100, right: 100 } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                },
                plugins: [{ afterDatasetsDraw: drawConnectorLines }]
            });
        }

        function createBarChart(ctx, labels, data, color, horizontal = false) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: color,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: horizontal ? 'y' : 'x',
                    layout: { padding: horizontal ? { right: 40 } : { top: 30 } },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        [horizontal ? 'x' : 'y']: { beginAtZero: true, ticks: { stepSize: 1 } },
                        [horizontal ? 'y' : 'x']: { grid: { display: false } }
                    }
                },
                plugins: [{ afterDatasetsDraw: (chart) => drawBarLabels(chart, horizontal) }]
            });
        }

        function drawConnectorLines(chart) {
            const ctx = chart.ctx;
            const meta = chart.getDatasetMeta(0);
            const centerX = chart.width / 2;
            const centerY = chart.height / 2;

            meta.data.forEach((element, index) => {
                const midAngle = (element.startAngle + element.endAngle) / 2;
                const labelRadius = element.outerRadius + 30;
                const labelX = centerX + Math.cos(midAngle) * labelRadius;
                const labelY = centerY + Math.sin(midAngle) * labelRadius;
                const startX = centerX + Math.cos(midAngle) * element.outerRadius;
                const startY = centerY + Math.sin(midAngle) * element.outerRadius;

                // Vẽ đường nối
                ctx.strokeStyle = chart.data.datasets[0].backgroundColor[index];
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(labelX, labelY);
                ctx.stroke();

                const label = chart.data.labels[index];
                const value = chart.data.datasets[0].data[index];
                const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);

                const offsetX = labelX > centerX ? 8 : labelX < centerX ? -8 : 0;
                const textX = labelX + offsetX;

                ctx.textAlign = labelX > centerX + 8 ? 'left' : labelX < centerX - 38 ? 'right' : 'center';
                ctx.textBaseline = 'middle';

                // Vẽ nền trắng cho text chính
                ctx.font = 'bold 14px Arial';
                const textWidth = ctx.measureText(`${label}: ${value}`).width;
                ctx.fillStyle = 'white';
                ctx.fillRect(textX - (ctx.textAlign === 'center' ? textWidth / 2 : ctx.textAlign === 'right' ? textWidth : 0) - 2,
                    labelY - 10 - 8, textWidth + 4, 16);

                // Vẽ text chính
                ctx.fillStyle = '#374151';
                ctx.fillText(`${label}: ${value}`, textX, labelY - 8);

                // Vẽ nền trắng cho phần trăm
                ctx.font = '12px Arial';
                const percentWidth = ctx.measureText(`(${percentage}%)`).width;
                ctx.fillStyle = 'white';
                ctx.fillRect(textX - (ctx.textAlign === 'center' ? percentWidth / 2 : ctx.textAlign === 'right' ? percentWidth : 0) - 2,
                    labelY + 5 - 7, percentWidth + 4, 14);

                // Vẽ phần trăm
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`(${percentage}%)`, textX, labelY + 5);
            });
        }

        function drawBarLabels(chart, horizontal) {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, i) => {
                chart.getDatasetMeta(i).data.forEach((element, index) => {
                    const data = dataset.data[index];
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 14px Arial';
                    if (horizontal) {
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(data, element.x + 10, element.y);
                    } else {
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(data, element.x, element.y - 8);
                    }
                });
            });
        }

        // ============================================
        // CHART UPDATE FUNCTIONS  
        // ============================================
        function updateChartsPH() {
            const data = state.PH.filteredData;

            // Status Chart
            if (state.PH.charts.status) state.PH.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartPH').getContext('2d');
            const statusData = [
                data.filter(i => i.TrangthaiPH === 'Còn hiệu lực' && !i.isExpiring).length,
                data.filter(i => i.isExpiring).length,
                data.filter(i => i.TrangthaiPH === 'Hết hiệu lực').length,
                data.filter(i => i.TrangthaiPH === 'Bị thu hồi').length
            ];
            state.PH.charts.status = createDoughnutChart(
                statusCtx,
                ['Còn hiệu lực', 'Sắp hết hạn', 'Hết hiệu lực', 'Bị thu hồi'],
                statusData,
                ['#10b981', '#f59e0b', '#ef4444', '#f97316']
            );

            // Type Chart
            if (state.PH.charts.type) state.PH.charts.type.destroy();
            const typeCtx = document.getElementById('typeChartPH').getContext('2d');
            const typeCounts = {};
            data.forEach(i => {
                const type = i.Loaiphuhieu || 'Không xác định';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            state.PH.charts.type = createBarChart(typeCtx, Object.keys(typeCounts), Object.values(typeCounts), '#3b82f6');

            // Trend Chart
            if (state.PH.charts.trend) state.PH.charts.trend.destroy();
            const trendCtx = document.getElementById('trendChartPH').getContext('2d');
            const monthCounts = {};
            data.forEach(i => {
                if (i.Ngaycap) {
                    const date = new Date(i.Ngaycap);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthCounts[key] = (monthCounts[key] || 0) + 1;
                }
            });
            const sorted = Object.keys(monthCounts).sort();
            state.PH.charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: sorted.map(m => m.split('-').reverse().join('/')),
                    datasets: [{
                        label: 'Số phù hiệu cấp mới',
                        data: sorted.map(m => monthCounts[m]),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30,
                            right: 20,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const data = dataset.data[index];
                                ctx.fillStyle = '#8b5cf6';
                                ctx.font = 'bold 14px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                ctx.fillText(data, element.x, element.y - 8);
                            });
                        });
                    }
                }]
            });
        }

        function updateChartsGPLX() {
            const data = state.GPLX.filteredData;

            // Status Chart
            if (state.GPLX.charts.status) state.GPLX.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartGPLX').getContext('2d');
            state.GPLX.charts.status = createDoughnutChart(
                statusCtx,
                ['Chưa xác định', 'Còn hiệu lực', 'Sắp hết hạn', 'Hết hạn'],
                [
                    data.filter(i => i.Trangthai === 'Chưa xác định').length,
                    data.filter(i => i.Trangthai === 'Còn hiệu lực').length,
                    data.filter(i => i.Trangthai === 'Sắp hết hạn').length,
                    data.filter(i => i.Trangthai === 'Hết hạn').length
                ],
                ['#9ca3af', '#10b981', '#f59e0b', '#ef4444']
            );

            // Hang Chart
            if (state.GPLX.charts.hang) state.GPLX.charts.hang.destroy();
            const hangCtx = document.getElementById('hangChartGPLX').getContext('2d');
            const hangCounts = {};
            data.forEach(i => {
                if (i.Hang) {
                    i.Hang.split(',').forEach(h => {
                        const hang = h.trim();
                        hangCounts[hang] = (hangCounts[hang] || 0) + 1;
                    });
                }
            });
            const labels = Object.keys(hangCounts).sort();
            state.GPLX.charts.hang = createBarChart(hangCtx, labels, labels.map(l => hangCounts[l]), '#8b5cf6');
        }

        function updateChartsNS() {
            const data = state.NS.filteredData;

            // Status Chart
            if (state.NS.charts.status) state.NS.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartNS').getContext('2d');
            state.NS.charts.status = createDoughnutChart(
                statusCtx,
                ['Đang làm việc', 'Đã nghỉ việc'],
                [
                    data.filter(i => i.Trangthai === 'Đang làm việc').length,
                    data.filter(i => i.Trangthai === 'Đã nghỉ việc').length
                ],
                ['#10b981', '#ef4444']
            );

            // ChucVu Chart
            if (state.NS.charts.chucVu) state.NS.charts.chucVu.destroy();
            const cvCtx = document.getElementById('chucVuChartNS').getContext('2d');
            const cvCounts = {};
            data.forEach(i => {
                const cvs = i.Chucvu ? i.Chucvu.toString().split(',') : ['Không xác định'];
                cvs.forEach(cv => {
                    const c = cv.trim();
                    cvCounts[c] = (cvCounts[c] || 0) + 1;
                });
            });
            state.NS.charts.chucVu = createBarChart(cvCtx, Object.keys(cvCounts), Object.values(cvCounts), '#3b82f6');

            // Gender Chart
            if (state.NS.charts.gender) state.NS.charts.gender.destroy();
            const genderCtx = document.getElementById('genderChartNS').getContext('2d');
            const genderCounts = {};
            data.forEach(i => {
                const g = i.Gioitinh || 'Không xác định';
                genderCounts[g] = (genderCounts[g] || 0) + 1;
            });
            state.NS.charts.gender = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{ data: Object.values(genderCounts), backgroundColor: ['#3b82f6', '#ec4899', '#6b7280'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Education Chart
            if (state.NS.charts.education) state.NS.charts.education.destroy();
            const eduCtx = document.getElementById('educationChartNS').getContext('2d');
            const eduCounts = {};
            data.forEach(i => {
                const e = i.Trinhdo || 'Không xác định';
                eduCounts[e] = (eduCounts[e] || 0) + 1;
            });
            state.NS.charts.education = createBarChart(eduCtx, Object.keys(eduCounts), Object.values(eduCounts), '#8b5cf6', true);
        }

        function updateChartsDK() {
            const data = state.DK.filteredData;

            // Status Chart
            if (state.DK.charts.status) state.DK.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartDK').getContext('2d');
            state.DK.charts.status = createDoughnutChart(
                statusCtx,
                ['Chưa đăng kiểm', 'Còn hiệu lực', 'Sắp hết hạn', 'Hết hạn'],
                [
                    data.filter(i => i.Trangthai === 'Chưa đăng kiểm').length,
                    data.filter(i => i.Trangthai === 'Còn hiệu lực').length,
                    data.filter(i => i.Trangthai === 'Sắp hết hạn').length,
                    data.filter(i => i.Trangthai === 'Hết hạn').length
                ],
                ['#9ca3af', '#10b981', '#f59e0b', '#ef4444']
            );

            // CoQuan Chart
            if (state.DK.charts.coQuan) state.DK.charts.coQuan.destroy();
            const coQuanCtx = document.getElementById('coQuanChartDK').getContext('2d');
            const coQuanCounts = {};
            data.forEach(i => {
                const cq = i.CoquanDK || 'Không xác định';
                coQuanCounts[cq] = (coQuanCounts[cq] || 0) + 1;
            });
            state.DK.charts.coQuan = createBarChart(coQuanCtx, Object.keys(coQuanCounts), Object.values(coQuanCounts), '#3b82f6', true);
        }

        function updateChartsTH() {
            const data = state.TH.filteredData;

            // Status Chart
            if (state.TH.charts.status) state.TH.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartTH').getContext('2d');
            state.TH.charts.status = createDoughnutChart(
                statusCtx,
                ['Chưa có', 'Còn hiệu lực', 'Sắp hết hạn', 'Hết hiệu lực'],
                [
                    data.filter(i => i.HieulucGCN === 'Chưa có').length,
                    data.filter(i => i.HieulucGCN === 'Còn hiệu lực').length,
                    data.filter(i => i.HieulucGCN === 'Sắp hết hạn').length,
                    data.filter(i => i.HieulucGCN === 'Hết hiệu lực').length
                ],
                ['#9ca3af', '#10b981', '#f59e0b', '#ef4444']
            );

            // ChuongTrinh Chart
            if (state.TH.charts.chuongTrinh) state.TH.charts.chuongTrinh.destroy();
            const ctCtx = document.getElementById('chuongTrinhChartTH').getContext('2d');
            const ctCounts = {};
            data.forEach(i => {
                const ct = i.ChuongTrinhDaoTao || 'Không xác định';
                ctCounts[ct] = (ctCounts[ct] || 0) + 1;
            });
            state.TH.charts.chuongTrinh = createBarChart(ctCtx, Object.keys(ctCounts), Object.values(ctCounts), '#8b5cf6');
        }

        function updateChartsSK() {
            const data = state.SK.filteredData;

            // Status Chart
            if (state.SK.charts.status) state.SK.charts.status.destroy();
            const statusCtx = document.getElementById('statusChartSK').getContext('2d');
            state.SK.charts.status = createDoughnutChart(
                statusCtx,
                ['Chưa có hạn', 'Còn hiệu lực', 'Sắp hết hạn', 'Hết hiệu lực'],
                [
                    data.filter(i => i.Hieuluc === 'Chưa có hạn').length,
                    data.filter(i => i.Hieuluc === 'Còn hiệu lực').length,
                    data.filter(i => i.Hieuluc === 'Sắp hết hạn').length,
                    data.filter(i => i.Hieuluc === 'Hết hiệu lực').length
                ],
                ['#9ca3af', '#10b981', '#f59e0b', '#ef4444']
            );

            // KetQua Chart
            if (state.SK.charts.ketQua) state.SK.charts.ketQua.destroy();
            const kqCtx = document.getElementById('ketQuaChartSK').getContext('2d');
            const kqCounts = {};
            data.forEach(i => {
                const kq = i.KetQua || 'Không xác định';
                kqCounts[kq] = (kqCounts[kq] || 0) + 1;
            });
            state.SK.charts.ketQua = new Chart(kqCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(kqCounts),
                    datasets: [{ data: Object.values(kqCounts), backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#6b7280'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // ============================================
        // FILTER FUNCTIONS
        // ============================================
        function updateFiltersPH() {
            const types = [...new Set(state.PH.allData.map(i => i.Loaiphuhieu))].filter(Boolean);
            document.getElementById('typeFilterPH').innerHTML = '<option value="">Tất cả</option>' +
                types.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function updateFiltersGPLX() {
            const hangs = new Set();
            state.GPLX.allData.forEach(i => {
                if (i.Hang) i.Hang.split(',').forEach(h => hangs.add(h.trim()));
            });
            document.getElementById('hangFilterGPLX').innerHTML = '<option value="">Tất cả</option>' +
                [...hangs].sort().map(h => `<option value="${h}">${h}</option>`).join('');

            const coQuans = [...new Set(state.GPLX.allData.map(i => i.Coquancap))].filter(Boolean);
            document.getElementById('coQuanCapFilterGPLX').innerHTML = '<option value="">Tất cả</option>' +
                coQuans.map(c => `<option value="${c}">${c}</option>`).join('');

            document.getElementById('statusFilterGPLX').innerHTML = '<option value="">Tất cả</option>' +
                '<option value="Chưa xác định">Chưa xác định</option>' +
                '<option value="Còn hiệu lực">Còn hiệu lực</option>' +
                '<option value="Sắp hết hạn">Sắp hết hạn</option>' +
                '<option value="Hết hạn">Hết hạn</option>';
        }

        function updateFiltersNS() {
            const cvs = new Set();
            state.NS.allData.forEach(i => {
                if (i.Chucvu) i.Chucvu.toString().split(',').forEach(cv => cvs.add(cv.trim()));
            });
            document.getElementById('chucVuFilterNS').innerHTML = '<option value="">Tất cả</option>' +
                [...cvs].filter(Boolean).sort().map(cv => `<option value="${cv}">${cv}</option>`).join('');

            const genders = [...new Set(state.NS.allData.map(i => i.Gioitinh))].filter(Boolean);
            document.getElementById('genderFilterNS').innerHTML = '<option value="">Tất cả</option>' +
                genders.map(g => `<option value="${g}">${g}</option>`).join('');

            const trinhdos = [...new Set(state.NS.allData.map(i => i.Trinhdo))].filter(Boolean);
            document.getElementById('trinhDoFilterNS').innerHTML = '<option value="">Tất cả</option>' +
                trinhdos.map(t => `<option value="${t}">${t}</option>`).join('');

            document.getElementById('statusFilterNS').innerHTML = '<option value="">Tất cả</option>' +
                '<option value="Đang làm việc">Đang làm việc</option>' +
                '<option value="Đã nghỉ việc">Đã nghỉ việc</option>';

            const tinhs = [...new Set(state.NS.allData.map(i => i.Tinhmoi))].filter(Boolean);
            document.getElementById('tinhFilterNS').innerHTML = '<option value="">Tất cả</option>' +
                tinhs.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function updateFiltersDK() {
            const coQuans = [...new Set(state.DK.allData.map(i => i.CoquanDK))].filter(Boolean);
            document.getElementById('coQuanFilterDK').innerHTML = '<option value="">Tất cả</option>' +
                coQuans.map(c => `<option value="${c}">${c}</option>`).join('');

            document.getElementById('statusFilterDK').innerHTML = '<option value="">Tất cả</option>' +
                '<option value="Chưa đăng kiểm">Chưa đăng kiểm</option>' +
                '<option value="Còn hiệu lực">Còn hiệu lực</option>' +
                '<option value="Sắp hết hạn">Sắp hết hạn</option>' +
                '<option value="Hết hạn">Hết hạn</option>';
        }

        function updateFiltersTH() {
            const chuongTrinhs = [...new Set(state.TH.allData.map(i => i.ChuongTrinhDaoTao))].filter(Boolean);
            document.getElementById('chuongTrinhFilterTH').innerHTML = '<option value="">Tất cả</option>' +
                chuongTrinhs.map(ct => `<option value="${ct}">${ct}</option>`).join('');

            const donVis = [...new Set(state.TH.allData.map(i => i.DonViToChuc))].filter(Boolean);
            document.getElementById('donViFilterTH').innerHTML = '<option value="">Tất cả</option>' +
                donVis.map(dv => `<option value="${dv}">${dv}</option>`).join('');

            document.getElementById('statusFilterTH').innerHTML = '<option value="">Tất cả</option>' +
                '<option value="Chưa có">Chưa có</option>' +
                '<option value="Còn hiệu lực">Còn hiệu lực</option>' +
                '<option value="Sắp hết hạn">Sắp hết hạn</option>' +
                '<option value="Hết hiệu lực">Hết hiệu lực</option>';
        }

        function updateFiltersSK() {
            const coSoYTes = [...new Set(state.SK.allData.map(i => i.CoSoYTe))].filter(Boolean);
            document.getElementById('coSoYTeFilterSK').innerHTML = '<option value="">Tất cả</option>' +
                coSoYTes.map(cs => `<option value="${cs}">${cs}</option>`).join('');

            const ketQuas = [...new Set(state.SK.allData.map(i => i.KetQua))].filter(Boolean);
            document.getElementById('ketQuaFilterSK').innerHTML = '<option value="">Tất cả</option>' +
                ketQuas.map(kq => `<option value="${kq}">${kq}</option>`).join('');

            document.getElementById('statusFilterSK').innerHTML = '<option value="">Tất cả</option>' +
                '<option value="Chưa có hạn">Chưa có hạn</option>' +
                '<option value="Còn hiệu lực">Còn hiệu lực</option>' +
                '<option value="Sắp hết hạn">Sắp hết hạn</option>' +
                '<option value="Hết hiệu lực">Hết hiệu lực</option>';
        }

        function applyFiltersPH() {
            const type = document.getElementById('typeFilterPH').value;
            const status = document.getElementById('statusFilterPH').value;
            const from = document.getElementById('fromDatePH').value;
            const to = document.getElementById('toDatePH').value;
            const search = document.getElementById('searchInputPH').value.toLowerCase();

            state.PH.filteredData = state.PH.allData.filter(i => {
                if (type && i.Loaiphuhieu !== type) return false;
                if (status && i.TrangthaiPH !== status) return false;
                if (from && i.Ngaycap && new Date(i.Ngaycap) < new Date(from)) return false;
                if (to && i.Ngaycap && new Date(i.Ngaycap) > new Date(to)) return false;
                if (search) {
                    const text = [i.SoPH, i.BienSoXe, i.Loaiphuhieu, i.TenTuyen].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.PH.currentPage = 1;
            updateStatsPH();
            updateChartsPH();
            renderTablePH();
        }

        function applyFiltersGPLX() {
            const hang = document.getElementById('hangFilterGPLX').value;
            const coQuan = document.getElementById('coQuanCapFilterGPLX').value;
            const status = document.getElementById('statusFilterGPLX').value;
            const from = document.getElementById('fromDateGPLX').value;
            const to = document.getElementById('toDateGPLX').value;
            const search = document.getElementById('searchInputGPLX').value.toLowerCase();

            state.GPLX.filteredData = state.GPLX.allData.filter(i => {
                if (hang && i.Hang && !i.Hang.split(',').map(h => h.trim()).includes(hang)) return false;
                if (hang && !i.Hang) return false;
                if (coQuan && i.Coquancap !== coQuan) return false;
                if (status && i.Trangthai !== status) return false;
                if (from && i.Ngaycap && new Date(i.Ngaycap) < new Date(from)) return false;
                if (to && i.Ngaycap && new Date(i.Ngaycap) > new Date(to)) return false;
                if (search) {
                    const text = [i.soGPLX, i.Hoten, i.Hang, i.Coquancap].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.GPLX.currentPage = 1;
            updateStatsGPLX();
            updateChartsGPLX();
            renderTableGPLX();
        }

        function applyFiltersNS() {
            const cv = document.getElementById('chucVuFilterNS').value;
            const gender = document.getElementById('genderFilterNS').value;
            const td = document.getElementById('trinhDoFilterNS').value;
            const status = document.getElementById('statusFilterNS').value;
            const tinh = document.getElementById('tinhFilterNS').value;
            const search = document.getElementById('searchInputNS').value.toLowerCase();

            state.NS.filteredData = state.NS.allData.filter(i => {
                if (cv && i.Chucvu && !i.Chucvu.toString().split(',').map(c => c.trim()).includes(cv)) return false;
                if (cv && !i.Chucvu) return false;
                if (gender && i.Gioitinh !== gender) return false;
                if (td && i.Trinhdo !== td) return false;
                if (status && i.Trangthai !== status) return false;
                if (tinh && i.Tinhmoi !== tinh) return false;
                if (search) {
                    const text = [i.IDNS, i.Hoten, i.NoCCCD, i.Sodienthoai, i.Email].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.NS.currentPage = 1;
            updateStatsNS();
            updateChartsNS();
            renderTableNS();
        }

        function applyFiltersDK() {
            const coQuan = document.getElementById('coQuanFilterDK').value;
            const status = document.getElementById('statusFilterDK').value;
            const from = document.getElementById('fromDateDK').value;
            const to = document.getElementById('toDateDK').value;
            const search = document.getElementById('searchInputDK').value.toLowerCase();

            state.DK.filteredData = state.DK.allData.filter(i => {
                if (coQuan && i.CoquanDK !== coQuan) return false;
                if (status && i.Trangthai !== status) return false;
                if (from && i.Ngaydangkiem && new Date(i.Ngaydangkiem) < new Date(from)) return false;
                if (to && i.Ngaydangkiem && new Date(i.Ngaydangkiem) > new Date(to)) return false;
                if (search) {
                    const text = [i.ID_KiemDinh, i.BienSoXe, i.CoquanDK].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.DK.currentPage = 1;
            updateStatsDK();
            updateChartsDK();
            renderTableDK();
        }

        function applyFiltersTH() {
            const chuongTrinh = document.getElementById('chuongTrinhFilterTH').value;
            const donVi = document.getElementById('donViFilterTH').value;
            const status = document.getElementById('statusFilterTH').value;
            const from = document.getElementById('fromDateTH').value;
            const to = document.getElementById('toDateTH').value;
            const search = document.getElementById('searchInputTH').value.toLowerCase();

            state.TH.filteredData = state.TH.allData.filter(i => {
                if (chuongTrinh && i.ChuongTrinhDaoTao !== chuongTrinh) return false;
                if (donVi && i.DonViToChuc !== donVi) return false;
                if (status && i.HieulucGCN !== status) return false;
                if (from && i.ThoiGianToChuc_Tungay && new Date(i.ThoiGianToChuc_Tungay) < new Date(from)) return false;
                if (to && i.ThoiGianToChuc_Denngay && new Date(i.ThoiGianToChuc_Denngay) > new Date(to)) return false;
                if (search) {
                    const text = [i.ID_DT, i.Hoten, i.SoGCN].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.TH.currentPage = 1;
            updateStatsTH();
            updateChartsTH();
            renderTableTH();
        }

        function applyFiltersSK() {
            const coSoYTe = document.getElementById('coSoYTeFilterSK').value;
            const ketQua = document.getElementById('ketQuaFilterSK').value;
            const status = document.getElementById('statusFilterSK').value;
            const from = document.getElementById('fromDateSK').value;
            const to = document.getElementById('toDateSK').value;
            const search = document.getElementById('searchInputSK').value.toLowerCase();

            state.SK.filteredData = state.SK.allData.filter(i => {
                if (coSoYTe && i.CoSoYTe !== coSoYTe) return false;
                if (ketQua && i.KetQua !== ketQua) return false;
                if (status && i.Hieuluc !== status) return false;
                if (from && i.ThoiGianKiemTra && new Date(i.ThoiGianKiemTra) < new Date(from)) return false;
                if (to && i.ThoiGianKiemTra && new Date(i.ThoiGianKiemTra) > new Date(to)) return false;
                if (search) {
                    const text = [i.ID_SK, i.Hoten, i.CoSoYTe].join(' ').toLowerCase();
                    if (!text.includes(search)) return false;
                }
                return true;
            });

            state.SK.currentPage = 1;
            updateStatsSK();
            updateChartsSK();
            renderTableSK();
        }

        function clearFiltersPH() {
            document.getElementById('typeFilterPH').value = '';
            document.getElementById('statusFilterPH').value = '';
            document.getElementById('fromDatePH').value = '';
            document.getElementById('toDatePH').value = '';
            document.getElementById('searchInputPH').value = '';
            state.PH.filteredData = [...state.PH.allData];
            state.PH.currentPage = 1;
            updateStatsPH();
            updateChartsPH();
            renderTablePH();
        }

        function clearFiltersGPLX() {
            document.getElementById('hangFilterGPLX').value = '';
            document.getElementById('coQuanCapFilterGPLX').value = '';
            document.getElementById('statusFilterGPLX').value = '';
            document.getElementById('fromDateGPLX').value = '';
            document.getElementById('toDateGPLX').value = '';
            document.getElementById('searchInputGPLX').value = '';
            state.GPLX.filteredData = [...state.GPLX.allData];
            state.GPLX.currentPage = 1;
            updateStatsGPLX();
            updateChartsGPLX();
            renderTableGPLX();
        }

        function clearFiltersNS() {
            document.getElementById('chucVuFilterNS').value = '';
            document.getElementById('genderFilterNS').value = '';
            document.getElementById('trinhDoFilterNS').value = '';
            document.getElementById('statusFilterNS').value = '';
            document.getElementById('tinhFilterNS').value = '';
            document.getElementById('searchInputNS').value = '';
            state.NS.filteredData = [...state.NS.allData];
            state.NS.currentPage = 1;
            updateStatsNS();
            updateChartsNS();
            renderTableNS();
        }

        function clearFiltersDK() {
            document.getElementById('coQuanFilterDK').value = '';
            document.getElementById('statusFilterDK').value = '';
            document.getElementById('fromDateDK').value = '';
            document.getElementById('toDateDK').value = '';
            document.getElementById('searchInputDK').value = '';
            state.DK.filteredData = [...state.DK.allData];
            state.DK.currentPage = 1;
            updateStatsDK();
            updateChartsDK();
            renderTableDK();
        }

        function clearFiltersTH() {
            document.getElementById('chuongTrinhFilterTH').value = '';
            document.getElementById('donViFilterTH').value = '';
            document.getElementById('statusFilterTH').value = '';
            document.getElementById('fromDateTH').value = '';
            document.getElementById('toDateTH').value = '';
            document.getElementById('searchInputTH').value = '';
            state.TH.filteredData = [...state.TH.allData];
            state.TH.currentPage = 1;
            updateStatsTH();
            updateChartsTH();
            renderTableTH();
        }

        function clearFiltersSK() {
            document.getElementById('coSoYTeFilterSK').value = '';
            document.getElementById('ketQuaFilterSK').value = '';
            document.getElementById('statusFilterSK').value = '';
            document.getElementById('fromDateSK').value = '';
            document.getElementById('toDateSK').value = '';
            document.getElementById('searchInputSK').value = '';
            state.SK.filteredData = [...state.SK.allData];
            state.SK.currentPage = 1;
            updateStatsSK();
            updateChartsSK();
            renderTableSK();
        }

        // ============================================
        // TABLE RENDERING
        // ============================================
        function getStatusClassPH(item) {
            if (item.isExpiring) return 'bg-yellow-100 text-yellow-800';
            const classes = {
                'Còn hiệu lực': 'bg-green-100 text-green-800',
                'Hết hiệu lực': 'bg-red-100 text-red-800',
                'Bị thu hồi': 'bg-orange-100 text-orange-800'
            };
            return classes[item.TrangthaiPH] || 'bg-gray-100 text-gray-800';
        }

        function getStatusTextPH(item) {
            return item.isExpiring ? 'Sắp hết hạn' : item.TrangthaiPH || '';
        }

        function getStatusClassGPLX(item) {
            const classes = {
                'Chưa xác định': 'bg-gray-100 text-gray-800',
                'Còn hiệu lực': 'bg-green-100 text-green-800',
                'Sắp hết hạn': 'bg-yellow-100 text-yellow-800',
                'Hết hạn': 'bg-red-100 text-red-800'
            };
            return classes[item.Trangthai] || 'bg-gray-100 text-gray-800';
        }

        function getStatusClassNS(item) {
            const classes = {
                'Đang làm việc': 'bg-green-100 text-green-800',
                'Đã nghỉ việc': 'bg-red-100 text-red-800'
            };
            return classes[item.Trangthai] || 'bg-green-100 text-green-800';
        }

        function getStatusClassDK(status) {
            const classes = {
                'Chưa đăng kiểm': 'bg-gray-100 text-gray-800',
                'Còn hiệu lực': 'bg-green-100 text-green-800',
                'Sắp hết hạn': 'bg-yellow-100 text-yellow-800',
                'Hết hạn': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusClassTH(status) {
            const classes = {
                'Chưa có': 'bg-gray-100 text-gray-800',
                'Còn hiệu lực': 'bg-green-100 text-green-800',
                'Sắp hết hạn': 'bg-yellow-100 text-yellow-800',
                'Hết hiệu lực': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusClassSK(status) {
            const classes = {
                'Chưa có hạn': 'bg-gray-100 text-gray-800',
                'Còn hiệu lực': 'bg-green-100 text-green-800',
                'Sắp hết hạn': 'bg-yellow-100 text-yellow-800',
                'Hết hiệu lực': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function renderTablePH() {
            const tbody = document.getElementById('tableBodyPH');
            const start = (state.PH.currentPage - 1) * state.PH.itemsPerPage;
            const end = start + state.PH.itemsPerPage;
            const pageData = state.PH.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.SoPH || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Loaiphuhieu || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.BienSoXe || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.TenTuyen || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngaycap)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngayhethan)}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassPH(item)}">${getStatusTextPH(item)}</span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${item.Ghichu || ''}</td>
            </tr>
        `).join('');

            updatePaginationPH();
        }

        function renderTableGPLX() {
            const tbody = document.getElementById('tableBodyGPLX');
            const start = (state.GPLX.currentPage - 1) * state.GPLX.itemsPerPage;
            const end = start + state.GPLX.itemsPerPage;
            const pageData = state.GPLX.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => {
                const hangBadges = item.Hang ? item.Hang.split(',').map(h =>
                    `<span class="inline-block px-2 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800 mr-1 mb-1">${h.trim()}</span>`
                ).join('') : '';

                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.soGPLX || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Hoten || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-500"><div class="flex flex-wrap">${hangBadges}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngaysinh)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngaycap)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngayhethan)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Coquancap || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassGPLX(item)}">${item.Trangthai}</span>
                    </td>
                </tr>
            `;
            }).join('');

            updatePaginationGPLX();
        }

        function renderTableNS() {
            const tbody = document.getElementById('tableBodyNS');
            const start = (state.NS.currentPage - 1) * state.NS.itemsPerPage;
            const end = start + state.NS.itemsPerPage;
            const pageData = state.NS.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.IDNS || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Hoten || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngaysinh)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Gioitinh || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Chucvu || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Trinhdo || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Sodienthoai || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Email || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassNS(item)}">${item.Trangthai}</span>
                </td>
            </tr>
        `).join('');

            updatePaginationNS();
        }

        function renderTableDK() {
            const tbody = document.getElementById('tableBodyDK');
            const start = (state.DK.currentPage - 1) * state.DK.itemsPerPage;
            const end = start + state.DK.itemsPerPage;
            const pageData = state.DK.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.ID_KiemDinh || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.BienSoXe || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngaydangkiem)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.Ngayhethan)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.CoquanDK || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassDK(item.Trangthai)}">${item.Trangthai}</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${item.GhiChu || ''}</td>
        </tr>
    `).join('');

            updatePaginationDK();
        }

        function renderTableTH() {
            const tbody = document.getElementById('tableBodyTH');
            const start = (state.TH.currentPage - 1) * state.TH.itemsPerPage;
            const end = start + state.TH.itemsPerPage;
            const pageData = state.TH.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.ID_DT || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Hoten || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ChuongTrinhDaoTao || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ThoiGianToChuc_Tungay)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ThoiGianToChuc_Denngay)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.SoGCN || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ThoiHanGCN)}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassTH(item.HieulucGCN)}">${item.HieulucGCN}</span>
            </td>
        </tr>
    `).join('');

            updatePaginationTH();
        }

        function renderTableSK() {
            const tbody = document.getElementById('tableBodySK');
            const start = (state.SK.currentPage - 1) * state.SK.itemsPerPage;
            const end = start + state.SK.itemsPerPage;
            const pageData = state.SK.filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((item, idx) => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${start + idx + 1}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.ID_SK || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.Hoten || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ThoiGianKiemTra)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.ThoihanGKSK)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.CoSoYTe || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.KetQua || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClassSK(item.Hieuluc)}">${item.Hieuluc}</span>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${item.Ghichu || ''}</td>
        </tr>
    `).join('');

            updatePaginationSK();
        }

        // ============================================
        // SORTING
        // ============================================
        function sortTable(column, type) {
            const s = state[type];

            if (s.sortColumn === column) {
                s.sortDirection = s.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                s.sortColumn = column;
                s.sortDirection = 'asc';
            }

            s.filteredData.sort((a, b) => {
                let valA, valB;

                if (column === 'stt') {
                    valA = s.filteredData.indexOf(a);
                    valB = s.filteredData.indexOf(b);
                } else if (['Ngaycap', 'Ngayhethan', 'Ngaysinh'].includes(column)) {
                    valA = new Date(a[column] || '1900-01-01');
                    valB = new Date(b[column] || '1900-01-01');
                } else {
                    valA = (a[column] || '').toString().toLowerCase();
                    valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return s.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return s.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            if (type === 'PH') renderTablePH();
            else if (type === 'GPLX') renderTableGPLX();
            else renderTableNS();
        }

        // ============================================
        // PAGINATION
        // ============================================
        function updatePaginationPH() {
            const s = state.PH;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemPH').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemPH').textContent = end;
            document.getElementById('totalItemsPH').textContent = s.filteredData.length;

            generatePagination('paginationPH', s.currentPage, total, page => {
                s.currentPage = page;
                renderTablePH();
            });

            document.getElementById('prevPageMobilePH').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobilePH').disabled = s.currentPage === total;
        }

        function updatePaginationGPLX() {
            const s = state.GPLX;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemGPLX').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemGPLX').textContent = end;
            document.getElementById('totalItemsGPLX').textContent = s.filteredData.length;

            generatePagination('paginationGPLX', s.currentPage, total, page => {
                s.currentPage = page;
                renderTableGPLX();
            });

            document.getElementById('prevPageMobileGPLX').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobileGPLX').disabled = s.currentPage === total;
        }

        function updatePaginationNS() {
            const s = state.NS;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemNS').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemNS').textContent = end;
            document.getElementById('totalItemsNS').textContent = s.filteredData.length;

            generatePagination('paginationNS', s.currentPage, total, page => {
                s.currentPage = page;
                renderTableNS();
            });

            document.getElementById('prevPageMobileNS').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobileNS').disabled = s.currentPage === total;
        }

        function updatePaginationDK() {
            const s = state.DK;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemDK').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemDK').textContent = end;
            document.getElementById('totalItemsDK').textContent = s.filteredData.length;

            generatePagination('paginationDK', s.currentPage, total, page => {
                s.currentPage = page;
                renderTableDK();
            });

            document.getElementById('prevPageMobileDK').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobileDK').disabled = s.currentPage === total;
        }

        function updatePaginationTH() {
            const s = state.TH;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemTH').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemTH').textContent = end;
            document.getElementById('totalItemsTH').textContent = s.filteredData.length;

            generatePagination('paginationTH', s.currentPage, total, page => {
                s.currentPage = page;
                renderTableTH();
            });

            document.getElementById('prevPageMobileTH').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobileTH').disabled = s.currentPage === total;
        }

        function updatePaginationSK() {
            const s = state.SK;
            const total = Math.ceil(s.filteredData.length / s.itemsPerPage);
            const start = (s.currentPage - 1) * s.itemsPerPage + 1;
            const end = Math.min(s.currentPage * s.itemsPerPage, s.filteredData.length);

            document.getElementById('fromItemSK').textContent = s.filteredData.length > 0 ? start : 0;
            document.getElementById('toItemSK').textContent = end;
            document.getElementById('totalItemsSK').textContent = s.filteredData.length;

            generatePagination('paginationSK', s.currentPage, total, page => {
                s.currentPage = page;
                renderTableSK();
            });

            document.getElementById('prevPageMobileSK').disabled = s.currentPage === 1;
            document.getElementById('nextPageMobileSK').disabled = s.currentPage === total;
        }

        function generatePagination(containerId, current, total, onClick) {
            const pagination = document.getElementById(containerId);
            pagination.innerHTML = '';

            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.className = `relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${current === 1 ? 'cursor-not-allowed opacity-50' : ''}`;
            prevBtn.disabled = current === 1;
            prevBtn.onclick = () => current > 1 && onClick(current - 1);
            pagination.appendChild(prevBtn);

            const maxVisible = 5;
            let start = Math.max(1, current - Math.floor(maxVisible / 2));
            let end = Math.min(total, start + maxVisible - 1);
            if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

            for (let i = start; i <= end; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${i === current ? 'z-10 bg-blue-600 border-blue-600 text-white' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`;
                btn.onclick = () => onClick(i);
                pagination.appendChild(btn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.className = `relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${current === total ? 'cursor-not-allowed opacity-50' : ''}`;
            nextBtn.disabled = current === total;
            nextBtn.onclick = () => current < total && onClick(current + 1);
            pagination.appendChild(nextBtn);
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tab) {
            state.currentTab = tab;

            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            const tabMap = {
                phuHieu: { id: 'tabPhuHieu', content: 'phuHieuContent', load: loadDataPH, state: 'PH' },
                gplx: { id: 'tabGPLX', content: 'gplxContent', load: loadDataGPLX, state: 'GPLX' },
                nhanSu: { id: 'tabNhanSu', content: 'nhanSuContent', load: loadDataNS, state: 'NS' },
                dangKiem: { id: 'tabDangKiem', content: 'dangKiemContent', load: loadDataDK, state: 'DK' },
                tapHuan: { id: 'tabTapHuan', content: 'tapHuanContent', load: loadDataTH, state: 'TH' },
                sucKhoe: { id: 'tabSucKhoe', content: 'sucKhoeContent', load: loadDataSK, state: 'SK' }
            };

            const selected = tabMap[tab];
            if (selected) {
                const tabBtn = document.getElementById(selected.id);
                tabBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
                tabBtn.classList.remove('border-transparent', 'text-gray-500');
                document.getElementById(selected.content).classList.remove('hidden');
                if (state[selected.state].allData.length === 0) selected.load();
            }
        }

        // ============================================
        // EXPORT TO EXCEL
        // ============================================
        function exportToExcel() {
            if (state.currentTab === 'phuHieu') exportPhuHieuToExcel();
            else if (state.currentTab === 'gplx') exportGPLXToExcel();
            else if (state.currentTab === 'nhanSu') exportNhanSuToExcel();
            else if (state.currentTab === 'dangKiem') exportDangKiemToExcel();
            else if (state.currentTab === 'tapHuan') exportTapHuanToExcel();
            else exportSucKhoeToExcel();
        }

        // Thêm hàm helper mới để tự động điều chỉnh độ rộng cột Excel:
        function autoFitColumns(worksheet, data) {
            const colWidths = {};

            // Tính độ rộng dựa trên tiêu đề
            Object.keys(data[0] || {}).forEach(key => {
                colWidths[key] = key.length;
            });

            // Tính độ rộng dựa trên nội dung
            data.forEach(row => {
                Object.keys(row).forEach(key => {
                    const cellValue = String(row[key] || '');
                    colWidths[key] = Math.max(colWidths[key] || 0, cellValue.length);
                });
            });

            // Áp dụng độ rộng (với padding thêm 2 ký tự)
            worksheet['!cols'] = Object.keys(colWidths).map(key => ({
                wch: Math.min(colWidths[key] + 2, 50) // Giới hạn tối đa 50 ký tự
            }));
        }


        function exportPhuHieuToExcel() {
            const data = state.PH.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Số phù hiệu': item.SoPH || '',
                'Loại phù hiệu': item.Loaiphuhieu || '',
                'Biển số xe': item.BienSoXe || '',
                'Tuyến': item.TenTuyen || '',
                'Ngày cấp': formatDate(item.Ngaycap),
                'Ngày hết hạn': formatDate(item.Ngayhethan),
                'Trạng thái': getStatusTextPH(item),
                'Ghi chú': item.Ghichu || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách phù hiệu');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số phù hiệu:', state.PH.filteredData.length],
                ['Còn hiệu lực:', state.PH.filteredData.filter(i => i.TrangthaiPH === 'Còn hiệu lực' && !i.isExpiring).length],
                ['Sắp hết hạn:', state.PH.filteredData.filter(i => i.isExpiring).length],
                ['Hết hiệu lực:', state.PH.filteredData.filter(i => i.TrangthaiPH === 'Hết hiệu lực').length],
                ['Bị thu hồi:', state.PH.filteredData.filter(i => i.TrangthaiPH === 'Bị thu hồi').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-phu-hieu-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportGPLXToExcel() {
            const data = state.GPLX.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Số GPLX': item.soGPLX || '',
                'Họ tên': item.Hoten || '',
                'Hạng': item.Hang || '',
                'Ngày sinh': formatDate(item.Ngaysinh),
                'Ngày cấp': formatDate(item.Ngaycap),
                'Ngày hết hạn': formatDate(item.Ngayhethan),
                'Cơ quan cấp': item.Coquancap || '',
                'Trạng thái': item.Trangthai || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách GPLX');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số GPLX:', state.GPLX.filteredData.length],
                ['Chưa xác định:', state.GPLX.filteredData.filter(i => i.Trangthai === 'Chưa xác định').length],
                ['Còn hiệu lực:', state.GPLX.filteredData.filter(i => i.Trangthai === 'Còn hiệu lực').length],
                ['Sắp hết hạn:', state.GPLX.filteredData.filter(i => i.Trangthai === 'Sắp hết hạn').length],
                ['Hết hạn:', state.GPLX.filteredData.filter(i => i.Trangthai === 'Hết hạn').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-GPLX-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportNhanSuToExcel() {
            const data = state.NS.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Mã NV': item.IDNS || '',
                'Họ tên': item.Hoten || '',
                'Ngày sinh': formatDate(item.Ngaysinh),
                'Giới tính': item.Gioitinh || '',
                'CCCD': item.NoCCCD || '',
                'Chức vụ': item.Chucvu || '',
                'Trình độ': item.Trinhdo || '',
                'Số điện thoại': item.Sodienthoai || '',
                'Email': item.Email || '',
                'Địa chỉ': item.Diachidaydu || '',
                'Tỉnh/TP': item.Tinhmoi || '',
                'Trạng thái': item.Trangthai || '',
                'Ghi chú': item.Ghichu || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách nhân sự');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số nhân sự:', state.NS.filteredData.length],
                ['Đang làm việc:', state.NS.filteredData.filter(i => i.Trangthai === 'Đang làm việc').length],
                ['Đã nghỉ việc:', state.NS.filteredData.filter(i => i.Trangthai === 'Đã nghỉ việc').length],
                ['Nam:', state.NS.filteredData.filter(i => i.Gioitinh === 'Nam').length],
                ['Nữ:', state.NS.filteredData.filter(i => i.Gioitinh === 'Nữ').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-nhan-su-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportDangKiemToExcel() {
            const data = state.DK.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Mã đăng kiểm': item.ID_KiemDinh || '',
                'Biển số xe': item.BienSoXe || '',
                'Ngày đăng kiểm': formatDate(item.Ngaydangkiem),
                'Ngày hết hạn': formatDate(item.Ngayhethan),
                'Cơ quan đăng kiểm': item.CoquanDK || '',
                'Trạng thái': item.Trangthai || '',
                'Ghi chú': item.GhiChu || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách đăng kiểm');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số đăng kiểm:', state.DK.filteredData.length],
                ['Còn hiệu lực:', state.DK.filteredData.filter(i => i.Trangthai === 'Còn hiệu lực').length],
                ['Sắp hết hạn:', state.DK.filteredData.filter(i => i.Trangthai === 'Sắp hết hạn').length],
                ['Hết hạn:', state.DK.filteredData.filter(i => i.Trangthai === 'Hết hạn').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-dang-kiem-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportTapHuanToExcel() {
            const data = state.TH.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Mã đào tạo': item.ID_DT || '',
                'Họ tên': item.Hoten || '',
                'Chương trình': item.ChuongTrinhDaoTao || '',
                'Từ ngày': formatDate(item.ThoiGianToChuc_Tungay),
                'Đến ngày': formatDate(item.ThoiGianToChuc_Denngay),
                'Đơn vị tổ chức': item.DonViToChuc || '',
                'Số GCN': item.SoGCN || '',
                'Thời hạn GCN': formatDate(item.ThoiHanGCN),
                'Trạng thái': item.HieulucGCN || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách tập huấn');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số chứng nhận:', state.TH.filteredData.length],
                ['Còn hiệu lực:', state.TH.filteredData.filter(i => i.HieulucGCN === 'Còn hiệu lực').length],
                ['Sắp hết hạn:', state.TH.filteredData.filter(i => i.HieulucGCN === 'Sắp hết hạn').length],
                ['Hết hiệu lực:', state.TH.filteredData.filter(i => i.HieulucGCN === 'Hết hiệu lực').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-tap-huan-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportSucKhoeToExcel() {
            const data = state.SK.filteredData.map((item, i) => ({
                'STT': i + 1,
                'Mã khám': item.ID_SK || '',
                'Họ tên': item.Hoten || '',
                'Ngày khám': formatDate(item.ThoiGianKiemTra),
                'Thời hạn': formatDate(item.ThoihanGKSK),
                'Cơ sở y tế': item.CoSoYTe || '',
                'Kết quả': item.KetQua || '',
                'Trạng thái': item.Hieuluc || '',
                'Ghi chú': item.Ghichu || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            autoFitColumns(ws, data);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh sách khám sức khỏe');

            const summary = [
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng số giấy khám:', state.SK.filteredData.length],
                ['Còn hiệu lực:', state.SK.filteredData.filter(i => i.Hieuluc === 'Còn hiệu lực').length],
                ['Sắp hết hạn:', state.SK.filteredData.filter(i => i.Hieuluc === 'Sắp hết hạn').length],
                ['Hết hiệu lực:', state.SK.filteredData.filter(i => i.Hieuluc === 'Hết hiệu lực').length],
                [''],
                ['Ngày xuất:', formatDate(new Date().toISOString())]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summary);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Thống kê');

            XLSX.writeFile(wb, `Bao-cao-suc-khoe-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('phuHieu');

            // Global buttons
            document.getElementById('refreshBtn').addEventListener('click', () => {
                if (state.currentTab === 'phuHieu') loadDataPH();
                else if (state.currentTab === 'gplx') loadDataGPLX();
                else loadDataNS();
            });
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);

            // PH Events
            document.getElementById('applyFilterPH').addEventListener('click', applyFiltersPH);
            document.getElementById('clearFilterPH').addEventListener('click', clearFiltersPH);
            document.getElementById('searchBtnPH').addEventListener('click', applyFiltersPH);
            document.getElementById('searchInputPH').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersPH());
            document.getElementById('searchInputPH').addEventListener('input', debounce(applyFiltersPH, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPagePH').addEventListener('change', e => {
                state.PH.itemsPerPage = parseInt(e.target.value);
                state.PH.currentPage = 1;
                renderTablePH();
            });
            document.getElementById('prevPageMobilePH').addEventListener('click', () => {
                if (state.PH.currentPage > 1) {
                    state.PH.currentPage--;
                    renderTablePH();
                }
            });
            document.getElementById('nextPageMobilePH').addEventListener('click', () => {
                const total = Math.ceil(state.PH.filteredData.length / state.PH.itemsPerPage);
                if (state.PH.currentPage < total) {
                    state.PH.currentPage++;
                    renderTablePH();
                }
            });

            // GPLX Events
            document.getElementById('applyFilterGPLX').addEventListener('click', applyFiltersGPLX);
            document.getElementById('clearFilterGPLX').addEventListener('click', clearFiltersGPLX);
            document.getElementById('searchBtnGPLX').addEventListener('click', applyFiltersGPLX);
            document.getElementById('searchInputGPLX').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersGPLX());
            document.getElementById('searchInputGPLX').addEventListener('input', debounce(applyFiltersGPLX, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPageGPLX').addEventListener('change', e => {
                state.GPLX.itemsPerPage = parseInt(e.target.value);
                state.GPLX.currentPage = 1;
                renderTableGPLX();
            });
            document.getElementById('prevPageMobileGPLX').addEventListener('click', () => {
                if (state.GPLX.currentPage > 1) {
                    state.GPLX.currentPage--;
                    renderTableGPLX();
                }
            });
            document.getElementById('nextPageMobileGPLX').addEventListener('click', () => {
                const total = Math.ceil(state.GPLX.filteredData.length / state.GPLX.itemsPerPage);
                if (state.GPLX.currentPage < total) {
                    state.GPLX.currentPage++;
                    renderTableGPLX();
                }
            });

            // NS Events
            document.getElementById('applyFilterNS').addEventListener('click', applyFiltersNS);
            document.getElementById('clearFilterNS').addEventListener('click', clearFiltersNS);
            document.getElementById('searchBtnNS').addEventListener('click', applyFiltersNS);
            document.getElementById('searchInputNS').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersNS());
            document.getElementById('searchInputNS').addEventListener('input', debounce(applyFiltersNS, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPageNS').addEventListener('change', e => {
                state.NS.itemsPerPage = parseInt(e.target.value);
                state.NS.currentPage = 1;
                renderTableNS();
            });
            document.getElementById('prevPageMobileNS').addEventListener('click', () => {
                if (state.NS.currentPage > 1) {
                    state.NS.currentPage--;
                    renderTableNS();
                }
            });
            document.getElementById('nextPageMobileNS').addEventListener('click', () => {
                const total = Math.ceil(state.NS.filteredData.length / state.NS.itemsPerPage);
                if (state.NS.currentPage < total) {
                    state.NS.currentPage++;
                    renderTableNS();
                }
            });

            // DK Events
            document.getElementById('applyFilterDK').addEventListener('click', applyFiltersDK);
            document.getElementById('clearFilterDK').addEventListener('click', clearFiltersDK);
            document.getElementById('searchBtnDK').addEventListener('click', applyFiltersDK);
            document.getElementById('searchInputDK').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersDK());
            document.getElementById('searchInputDK').addEventListener('input', debounce(applyFiltersDK, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPageDK').addEventListener('change', e => {
                state.DK.itemsPerPage = parseInt(e.target.value);
                state.DK.currentPage = 1;
                renderTableDK();
            });
            document.getElementById('prevPageMobileDK').addEventListener('click', () => {
                if (state.DK.currentPage > 1) {
                    state.DK.currentPage--;
                    renderTableDK();
                }
            });
            document.getElementById('nextPageMobileDK').addEventListener('click', () => {
                const total = Math.ceil(state.DK.filteredData.length / state.DK.itemsPerPage);
                if (state.DK.currentPage < total) {
                    state.DK.currentPage++;
                    renderTableDK();
                }
            });

            // TH Events
            document.getElementById('applyFilterTH').addEventListener('click', applyFiltersTH);
            document.getElementById('clearFilterTH').addEventListener('click', clearFiltersTH);
            document.getElementById('searchBtnTH').addEventListener('click', applyFiltersTH);
            document.getElementById('searchInputTH').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersTH());
            document.getElementById('searchInputTH').addEventListener('input', debounce(applyFiltersTH, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPageTH').addEventListener('change', e => {
                state.TH.itemsPerPage = parseInt(e.target.value);
                state.TH.currentPage = 1;
                renderTableTH();
            });
            document.getElementById('prevPageMobileTH').addEventListener('click', () => {
                if (state.TH.currentPage > 1) {
                    state.TH.currentPage--;
                    renderTableTH();
                }
            });
            document.getElementById('nextPageMobileTH').addEventListener('click', () => {
                const total = Math.ceil(state.TH.filteredData.length / state.TH.itemsPerPage);
                if (state.TH.currentPage < total) {
                    state.TH.currentPage++;
                    renderTableTH();
                }
            });

            // SK Events
            document.getElementById('applyFilterSK').addEventListener('click', applyFiltersSK);
            document.getElementById('clearFilterSK').addEventListener('click', clearFiltersSK);
            document.getElementById('searchBtnSK').addEventListener('click', applyFiltersSK);
            document.getElementById('searchInputSK').addEventListener('keypress', e => e.key === 'Enter' && applyFiltersSK());
            document.getElementById('searchInputSK').addEventListener('input', debounce(applyFiltersSK, CONFIG.DEBOUNCE_DELAY));
            document.getElementById('itemsPerPageSK').addEventListener('change', e => {
                state.SK.itemsPerPage = parseInt(e.target.value);
                state.SK.currentPage = 1;
                renderTableSK();
            });
            document.getElementById('prevPageMobileSK').addEventListener('click', () => {
                if (state.SK.currentPage > 1) {
                    state.SK.currentPage--;
                    renderTableSK();
                }
            });
            document.getElementById('nextPageMobileSK').addEventListener('click', () => {
                const total = Math.ceil(state.SK.filteredData.length / state.SK.itemsPerPage);
                if (state.SK.currentPage < total) {
                    state.SK.currentPage++;
                    renderTableSK();
                }
            });

            // Auto refresh - cập nhật phần auto refresh
            setInterval(() => {
                if (state.currentTab === 'phuHieu' && state.PH.allData.length > 0) loadDataPH();
                else if (state.currentTab === 'gplx' && state.GPLX.allData.length > 0) loadDataGPLX();
                else if (state.currentTab === 'nhanSu' && state.NS.allData.length > 0) loadDataNS();
                else if (state.currentTab === 'dangKiem' && state.DK.allData.length > 0) loadDataDK();
                else if (state.currentTab === 'tapHuan' && state.TH.allData.length > 0) loadDataTH();
                else if (state.currentTab === 'sucKhoe' && state.SK.allData.length > 0) loadDataSK();
            }, CONFIG.REFRESH_INTERVAL);
        });

        // Disable right-click and F12
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>