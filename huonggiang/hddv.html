<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hợp Đồng Dịch Vụ HTX</title>
    
    <!-- Thêm các thư viện cần thiết cho xuất Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @page {
            size: A4;
            margin: 0;
        }

        body {
            font-family: "Times New Roman", serif;
            font-size: 13px;
            line-height: 1.6;
            background: white;
            width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            min-height: 297mm;
            position: relative;
        }

        .button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: "Times New Roman", serif;
        }

        .print-button {
            background-color: #4CAF50;
            color: white;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        .export-button {
            background-color: #2b579a;
            color: white;
        }

        .export-button:hover {
            background-color: #1e3f6f;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }

        /* Document styling */
        .document-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .country-info {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .motto {
            font-size: 13px;
            text-decoration: underline;
            margin-bottom: 30px;
        }

        .contract-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .contract-subtitle {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .contract-number {
            font-size: 13px;
            margin-bottom: 20px;
        }

        .legal-basis {
            text-align: left;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .today-info {
            text-align: left;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .party-section {
            margin-bottom: 25px;
            text-align: left;
        }

        .party-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .party-info {
            margin-left: 10px;
            line-height: 1.8;
        }

        .vehicle-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .vehicle-table th,
        .vehicle-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }

        .vehicle-table th {
            font-weight: bold;
        }

        .agreement-text {
            text-align: left;
            margin: 20px 0;
            line-height: 1.8;
        }

        .article-title {
            font-weight: bold;
            margin: 15px 0 10px 0;
            text-align: center;
        }

        .article-content {
            margin-bottom: 15px;
            text-indent: 20px;
        }

        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            text-align: center;
        }

        .signature-box {
            width: 45%;
        }

        .signature-title {
            font-weight: bold;
            margin-bottom: 80px;
        }

        .signature-name {
            font-weight: bold;
        }

        @media print {
            body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 20mm;
            }

            .button-container {
                display: none;
            }
        }

        @media screen {
            body {
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                margin: 20px auto;
            }
        }
    </style>
</head>

<body>
    <!-- Button Container -->
    <div class="button-container">
        <button class="button print-button" onclick="window.print()">
            <i class="fas fa-print"></i> In Tài Liệu
        </button>
        <button class="button export-button" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <!-- Document Content -->
    <div class="document-header">
        <div class="country-info">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
        <div class="motto">Độc lập - Tự do - Hạnh phúc</div>
        <div style="height: 20px;"></div>
        
        <div class="contract-title">HỢP ĐỒNG DỊCH VỤ</div>
        <div class="contract-subtitle">Giữa <span id="tendonvi">Tendonvi</span> và Thành viên HTX</div>
        <div class="contract-number">(Số: <span id="sovanban">SoVanBan</span>)</div>
    </div>

    <div class="legal-basis">
        Căn cứ Luật Hợp tác xã số 17/2023/QH15;<br>
        Căn cứ Điều lệ Hợp tác xã;<br>
        Căn cứ nhu cầu và khả năng của các bên.
    </div>

    <div class="today-info">
        Hôm nay, ngày <span id="ngayky">NgayKy</span> tại Văn phòng <span id="tendonvi2">Tendonvi</span> (Địa chỉ: <span id="diachidaydu">{Diachidaydu}</span>), chúng tôi gồm:
    </div>

    <div class="party-section">
        <div class="party-title">I. <span id="tendonvi3">Tendonvi</span> (Bên A)</div>
        <div class="party-info">
            - Đại diện: <span id="nguoidaidien">Nguoidaidien</span>;<br>
            - Chức vụ: Giám đốc;<br>
            - Địa chỉ: <span id="diachidaydu2">Diachidaydu</span>;<br>
            - Số điện thoại: <span id="sodt">SoDT</span>;<br>
            - Mã số thuế: <span id="masothue">Masothue</span>;<br>
            - Số tài khoản: <span id="sotk">SoTK</span> - Tại Ngân hàng: <span id="tainganhang">TaiNganhang</span>.
        </div>
    </div>

    <div class="party-section">
        <div class="party-title">II. <span id="hoten">Hoten</span> (Bên B - Thành viên hợp tác xã)</div>
        <div class="party-info">
            Số Căn cước công dân: <span id="socccd">SoCCCD</span>.<br>
            Địa chỉ: <span id="diachns">DiachiNhanSu</span>.<br>
            Là chủ sở hữu phương tiện:
        </div>

        <table class="vehicle-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Biển số</th>
                    <th>Số khung</th>
                    <th>Số máy</th>
                    <th>Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td id="ref-xe">Ref_Xe</td>
                    <td id="sokhung">Sokhung</td>
                    <td id="somay">Somay</td>
                    <td id="ghichu">Ghichu</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="agreement-text">
        Hai bên cùng bàn bạc, thống nhất và cùng đồng ý ký kết hợp đồng dịch vụ giữa hợp tác xã và thành viên HTX với các điều khoản sau:
        
        <div class="article-title">Điều 1. Nội dung hợp đồng</div>
        <div class="article-content">
            Kể từ ngày Hợp đồng này có hiệu lực Bên B giao toàn quyền quản lý, sử dụng phương tiện <span id="ref-xe2">Ref_Xe</span> cho Bên A để thực hiện hoạt động kinh doanh vận tải bằng xe ô tô theo quy định của pháp luật.
        </div>
        <div class="article-content">
            Thời hạn hợp đồng: Không thời hạn và kết thúc khi Bên B không còn là thành viên hợp tác xã (HTX) theo quy định của pháp luật và Điều lệ HTX.
        </div>

        <div class="article-title">Điều 2. Giá trị hợp đồng và phương thức thanh toán hợp đồng</div>
        <div class="article-content">
            1. Giá trị hợp đồng: Thành viên HTX được hưởng lợi nhuận từ lợi nhuận của việc kinh doanh vận tải bằng xe ô tô của phương tiện <span id="ref-xe3">Ref_Xe</span> theo quy định tại Điều lệ HTX.
        </div>
        <div class="article-content">
            2. Phương thức thanh toán: Tiền mặt (hoặc chuyển khoản) trước ngày 05 của tháng tiếp theo sau.
        </div>

        <div class="article-title">Điều 3: Trách nhiệm, quyền hạn Bên B</div>
        <div class="article-content">
            1. Trách nhiệm của bên B:<br>
            a) Giao xe và toàn bộ giấy tờ liên quan đến xe <span id="ref-xe4">Ref_Xe</span> ngay sau khi Hợp đồng có hiệu lực. Giấy tờ liên quan đến xe gồm: Giấy chứng nhận đăng ký xe (hoặc giấy tờ có giá trị tương đương), giấy chứng nhận kiểm định chất lượng an toàn kỹ thuật và bảo vệ môi trường, giấy chứng nhận bảo hiểm trách nhiệm xe cơ giới và các giấy tờ khác có liên quan;<br>
            b) Chịu trách nhiệm pháp lý về nguồn gốc và quyền sở hữu của xe;<br>
            c) Chấp hành các quy định khác tại Điều lệ của HTX.
        </div>
        <div class="article-content">
            2. Quyền hạn của Bên B<br>
            a) Được phần phối lợi nhuận từ việc hoạt động kinh doanh vận tải bằng xe ô tô của phương tiền <span id="ref-xe5">Ref_Xe</span> theo quy định của Điều lệ HTX;<br>
            b) Được ra khỏi hợp tác xã theo quy định của Điều lệ HTX;<br>
            c) Khiếu nại, tố cáo, khởi kiện theo quy định của pháp luật;<br>
            d) Quyền khác theo quy định pháp luật và Điều lệ HTX.
        </div>

        <div class="article-title">Điều 4. Trách nhiệm, quyền hạn của Bên A</div>
        <div class="article-content">
            1. Trách nhiệm<br>
            a) Kiểm tra, xác minh tính hợp pháp về nguồn gốc và quyền sở hữu của Bên B đối với phương tiện <span id="ref-xe6">Ref_Xe</span> và tình trạng kỹ thuật của phương tiện trước khi thực hiện hoạt động kinh doanh;<br>
            b) Sử dụng phương tiện <span id="ref-xe7">Ref_Xe</span> vào đúng mục đích kinh doanh vận tải bằng ô tô được cơ quan có thẩm quyền cho phép;<br>
            c) Có trách nhiệm xây dựng và thực hiện kế hoạch bảo dưỡng, sửa chữa, thay thế hệ thống, tổng thành (nếu có) để phương tiện đảm bảo an toàn kỹ thuật và bảo vệ môi trường quy định;...
        </div>
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <div class="signature-title">ĐẠI DIỆN BÊN A</div>
            <div class="signature-name" id="nguoidaidien2">Nguoidaidien</div>
        </div>
        <div class="signature-box">
            <div class="signature-title">ĐẠI DIỆN BÊN B</div>
            <div class="signature-name" id="hoten2">Hoten</div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'c63948d1-e202-4400-a894-3e94f7f397f6';
        const accessKey = 'V2-Kz8H5-XrQQD-xSHTJ-BXZqO-04jXl-AKoDb-Ub0SX-rBouU';
        const region = 'www';

        // Biến toàn cục để lưu dữ liệu
        let globalContractData = null;

        // Function to get IDHoSo from URL
        function getIDHoSoFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('IDHoSo') || urlParams.get('idhoso');
        }

        // Function to fetch data from AppSheet
        async function fetchAppSheetData(tableName, filter = null) {
            try {
                const selector = filter || `Filter(${tableName}, true)`;
                console.log(`🔍 Executing selector for ${tableName}:`, selector);

                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: selector
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`🔍 Response for ${tableName}:`, data);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch ${tableName}:`, error);
                throw error;
            }
        }

        // Format ngày dài cho hiển thị
        function formatDateLongForWord(dateString) {
            if (!dateString || dateString === '' || dateString === '') {
                const today = new Date();
                const day = today.getDate().toString().padStart(2, '0');
                const month = today.getMonth() + 1;
                const year = today.getFullYear();

                let formattedMonth;
                if (month === 1 || month === 2) {
                    formattedMonth = month.toString().padStart(2, '0');
                } else {
                    formattedMonth = month.toString();
                }

                return `${day} tháng ${formattedMonth} năm ${year}`;
            }

            let day, month, year;

            if (typeof dateString === 'string' && dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    month = parseInt(parts[0]); // MM
                    day = parseInt(parts[1]);   // dd  
                    year = parseInt(parts[2]);  // yyyy
                }
            } else if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    year = parseInt(parts[0]);
                    month = parseInt(parts[1]);
                    day = parseInt(parts[2]);
                }
            } else if (dateString instanceof Date) {
                day = dateString.getDate();
                month = dateString.getMonth() + 1;
                year = dateString.getFullYear();
            } else {
                return dateString.toString();
            }

            if (!day || !month || !year || isNaN(day) || isNaN(month) || isNaN(year)) {
                return dateString.toString();
            }

            const formattedDay = day.toString().padStart(2, '0');

            let formattedMonth;
            if (month === 1 || month === 2) {
                formattedMonth = month.toString().padStart(2, '0');
            } else {
                formattedMonth = month.toString();
            }

            return `${formattedDay} tháng ${formattedMonth} năm ${year}`;
        }

        // Load data from AppSheet
        async function loadData() {
            try {
                const idHoSo = getIDHoSoFromURL();
                console.log('🔍 ID từ URL:', idHoSo);

                if (!idHoSo) {
                    throw new Error('Không tìm thấy IDHoSo trong URL');
                }

                // Fetch dữ liệu từ các bảng
                const [hosoList, donviList, xeList, nhansuList] = await Promise.all([
                    fetchAppSheetData('HOSONHANSU', `Filter(HOSONHANSU, [IDHoSo] = "${idHoSo}")`),
                    fetchAppSheetData('THONGTINDONVI'),
                    fetchAppSheetData('THONGTINXE'),
                    fetchAppSheetData('THONGTINNHANSU')
                ]);

                if (!hosoList || hosoList.length === 0) {
                    throw new Error('Không tìm thấy hồ sơ với ID này');
                }

                const hosoData = hosoList.find(item => item.IDHoSo === idHoSo);
                if (!hosoData) {
                    throw new Error(`Không tìm thấy ID "${idHoSo}"`);
                }

                const donviData = donviList.length > 0 ? donviList[0] : {};
                
                // Tìm thông tin xe
                const xeData = hosoData.Ref_Xe ? 
                    xeList.find(x => x.Idxe === hosoData.Ref_Xe) || {} : {};
                
                // Tìm thông tin nhân sự
                const nhansuData = hosoData.Ref_ThanhVien ? 
                    nhansuList.find(n => n.IDNS === hosoData.Ref_ThanhVien) || {} : {};

                // Lưu dữ liệu cho xuất Word
                globalContractData = {
                    IDHoSo: hosoData.IDHoSo || '',
                    SoVanBan: hosoData.SoVanBan || '',
                    NgayKy: formatDateLongForWord(hosoData.NgayKy),
                    Tendonvi: donviData.Tendonvi || '',
                    Nguoidaidien: donviData.Nguoidaidien || '',
                    Diachidaydu: donviData.Diachi || '',
                    SoDT: donviData.SoDT || '',
                    Masothue: donviData.Masothue || '',
                    SoTK: donviData.SoTK || '',
                    TaiNganhang: donviData.TaiNganhang || '',
                    Hoten: nhansuData.Hoten || '',
                    SoCCCD: nhansuData.NoCCCD || '',
                    DiachiNhanSu: nhansuData.Diachidaydu || '',
                    Ref_Xe: xeData.Bienso || '',
                    Sokhung: xeData.Sokhung || '',
                    Somay: xeData.Somay || '',
                    Ghichu: xeData.Ghichu || ''
                };

                // Populate HTML với dữ liệu
                populateHTML(globalContractData);
                hideLoadingMessage();

            } catch (error) {
                console.error('Error loading data:', error);
                hideLoadingMessage();
                alert('Lỗi: ' + error.message);
            }
        }

        // Populate HTML with data
        function populateHTML(data) {
            // Helper function to safely set text content
            const setText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || '';
                }
            };

            setText('tendonvi', data.Tendonvi);
            setText('tendonvi2', data.Tendonvi);
            setText('tendonvi3', data.Tendonvi);
            setText('sovanban', data.SoVanBan);
            setText('ngayky', data.NgayKy);
            setText('diachidaydu', data.Diachidaydu);
            setText('diachidaydu2', data.Diachidaydu);
            setText('nguoidaidien', data.Nguoidaidien);
            setText('nguoidaidien2', data.Nguoidaidien);
            setText('sodt', data.SoDT);
            setText('masothue', data.Masothue);
            setText('sotk', data.SoTK);
            setText('tainganhang', data.TaiNganhang);
            setText('hoten', data.Hoten);
            setText('hoten2', data.Hoten);
            setText('socccd', data.SoCCCD);
            setText('diachns', data.DiachiNhanSu);
            setText('ref-xe', data.Ref_Xe);
            setText('ref-xe2', data.Ref_Xe);
            setText('ref-xe3', data.Ref_Xe);
            setText('ref-xe4', data.Ref_Xe);
            setText('ref-xe5', data.Ref_Xe);
            setText('ref-xe6', data.Ref_Xe);
            setText('ref-xe7', data.Ref_Xe);
            setText('sokhung', data.Sokhung);
            setText('somay', data.Somay);
            setText('ghichu', data.Ghichu);
        }

        // Export to Word template
        async function exportToWordTemplate() {
            try {
                if (!globalContractData) {
                    alert('Dữ liệu chưa được tải. Vui lòng đợi dữ liệu tải xong.');
                    return;
                }

                document.getElementById('loading-message').style.display = 'block';
                document.getElementById('loading-message').textContent = 'Đang xuất file Word...';

                // URL template cho hợp đồng dịch vụ
                const templateUrl = 'https://poalninh.github.io/templates/templates/hddv_template.docx';
                
                const response = await fetch(templateUrl);
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }

                const templateContent = await response.arrayBuffer();
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                doc.setData(globalContractData);
                doc.render();

                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `HopDongDichVu_${globalContractData.SoVanBan}_${globalContractData.Hoten || 'Document'}.docx`;
                saveAs(blob, fileName);

                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi xuất file Word:', error);
                alert('Có lỗi xảy ra khi xuất file Word: ' + error.message);
                hideLoadingMessage();
            }
        }

        // Hide loading message
        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Initialize application
        async function initialize() {
            try {
                const idHoSo = getIDHoSoFromURL();
                if (!idHoSo) {
                    alert('Vui lòng cung cấp IDHoSo trong URL. Ví dụ: ?IDHoSo=HS001');
                    return;
                }
                await loadData();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Không thể kết nối với hệ thống. Vui lòng thử lại sau.');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                initialize();
            }, 500);
        });

        // Disable right-click and F12
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>