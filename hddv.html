<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Xu·∫•t H·ª£p ƒê·ªìng D·ªãch V·ª•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(22, 163, 74, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.05"/><circle cx="50" cy="50" r="0.5" fill="%23ffffff" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 1;
        }

        .header-title {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header-title h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-subtitle {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            font-weight: 400;
            text-align: center;
        }

        .emblem {
            position: absolute;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0.2;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Action Panel */
        .action-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .panel-header i {
            font-size: 1.5rem;
            color: #16a34a;
            margin-right: 1rem;
        }

        .panel-header h2 {
            color: #1e293b;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .action-button {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .action-button:not(:disabled)::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-button:not(:disabled):hover::before {
            left: 100%;
        }

        .action-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
        }

        .action-button:not(:disabled):active {
            transform: translateY(0);
        }

        .action-button i {
            font-size: 1.1rem;
        }

        /* Info Panel */
        .info-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .info-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .info-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 1rem 1.25rem;
            font-weight: 600;
            color: #1e40af;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item:hover {
            background: #f8fafc;
        }

        .info-label {
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #334155;
            font-weight: 500;
            word-break: break-word;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #64748b;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .error-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #dc2626;
        }

        .error-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            background: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 90%;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #1e293b;
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Status indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .status-ready {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fecaca;
            color: #dc2626;
        }

        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }

        .status-indicator i {
            font-size: 0.75rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }

            .emblem {
                display: none;
            }

            .container {
                padding: 1rem;
            }

            .action-panel,
            .info-panel {
                padding: 1.5rem 1rem;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .panel-header i {
                margin-right: 0;
            }

            .loading-content {
                padding: 1.5rem 2rem;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-panel,
        .info-panel {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-panel {
            animation-delay: 0.1s;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="emblem">
            <i class="fas fa-file-contract"></i>
        </div>
        <div class="header-content">
            <div class="header-title">
                <h1>Xu·∫•t H·ª£p ƒê·ªìng D·ªãch V·ª•</h1>
                <div class="header-subtitle">H·ªá th·ªëng xu·∫•t t√†i li·ªáu h·ª£p ƒë·ªìng d·ªãch v·ª• HTX</div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Action Panel -->
        <div class="action-panel">
            <div class="panel-header">
                <i class="fas fa-download"></i>
                <h2>Xu·∫•t T√†i Li·ªáu</h2>
            </div>
            <div class="button-group">
                <button class="action-button" id="export-button" onclick="exportToWordTemplate()" disabled>
                    <i class="fas fa-file-word"></i>
                    <span>Xu·∫•t H·ª£p ƒê·ªìng Word</span>
                </button>
            </div>
            <div id="status-indicator" class="status-indicator status-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>ƒêang t·∫£i d·ªØ li·ªáu...</span>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="panel-header">
                <i class="fas fa-info-circle"></i>
                <h2>Th√¥ng Tin H·ª£p ƒê·ªìng</h2>
            </div>

            <div id="param-display">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>ƒêang t·∫£i th√¥ng tin h·ªì s∆°...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = '50b5e0e5-79c2-42b8-a3bd-095741190d4c';
        const accessKey = 'V2-Bwq7a-rGM2F-aX9Zj-8h4gC-0JdWA-IzAqM-mtJr7-jcuBw';
        const region = 'www';

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u d·ªØ li·ªáu
        let globalData = null;
        let hosoData = null;
        let donviData = null;
        let xeData = null;
        let nhansuData = null;

        // Function to get IDHoSo from URL
        function getIDHoSoFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('IDHoSo') || urlParams.get('idhoso');
        }

        // Function to fetch data from AppSheet
        async function fetchAppSheetData(tableName, filter = null) {
            try {
                const selector = filter || `Filter(${tableName}, true)`;
                console.log(`üîç Executing selector for ${tableName}:`, selector);

                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: selector
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`üîç Response for ${tableName}:`, data);
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch ${tableName}:`, error);
                throw error;
            }
        }

        // Parse date t·ª´ ƒë·ªãnh d·∫°ng yyyy-mm-dd ho·∫∑c dd/mm/yyyy
        function parseDate(dateString) {
            if (!dateString) return new Date();

            // N·∫øu l√† ƒë·ªãnh d·∫°ng yyyy-mm-dd (t·ª´ AppSheet)
            if (dateString.includes('-') && dateString.length === 10) {
                return new Date(dateString);
            }

            // N·∫øu l√† ƒë·ªãnh d·∫°ng dd/mm/yyyy (t·ª´ AppSheet) - S·ª¨A PH·∫¶N N√ÄY
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Ch√∫ √Ω th·ª© t·ª±: parts[0] = day, parts[1] = month, parts[2] = year
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript month b·∫Øt ƒë·∫ßu t·ª´ 0
                    const year = parseInt(parts[2]);

                    // T·∫°o Date object ƒë√∫ng c√°ch
                    return new Date(year, month, day);
                }
            }

            return new Date(dateString);
        }

        // Format ng√†y cho template Word - X·ª¨ L√ù ƒê·ªäNH D·∫†NG MM/dd/yyyy
        function formatDateForWord(dateString) {
            console.log('üîç formatDateForWord - Input:', dateString, typeof dateString);

            if (!dateString || dateString === 'Kh√¥ng c√≥ th√¥ng tin' || dateString === '') {
                console.log('‚ùå No date data, returning default');
                return 'Kh√¥ng c√≥ th√¥ng tin';
            }

            let day, month, year;

            // N·∫øu l√† chu·ªói c√≥ d·∫•u / - X·ª¨ L√ù ƒê·ªäNH D·∫†NG MM/dd/yyyy t·ª´ AppSheet
            if (typeof dateString === 'string' && dateString.includes('/')) {
                console.log('üìÖ Processing MM/dd/yyyy format:', dateString);
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    month = parseInt(parts[0]); // Th√°ng ·ªü v·ªã tr√≠ ƒë·∫ßu (MM)
                    day = parseInt(parts[1]);   // Ng√†y ·ªü v·ªã tr√≠ gi·ªØa (dd)
                    year = parseInt(parts[2]);  // NƒÉm ·ªü v·ªã tr√≠ cu·ªëi (yyyy)
                }
            }
            // N·∫øu l√† chu·ªói c√≥ d·∫•u - (yyyy-mm-dd)
            else if (typeof dateString === 'string' && dateString.includes('-')) {
                console.log('üìÖ Processing yyyy-mm-dd format:', dateString);
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    year = parseInt(parts[0]);
                    month = parseInt(parts[1]);
                    day = parseInt(parts[2]);
                }
            }
            // N·∫øu l√† Date object
            else if (dateString instanceof Date) {
                console.log('üìÖ Processing Date object:', dateString);
                day = dateString.getDate();
                month = dateString.getMonth() + 1;
                year = dateString.getFullYear();
            }
            else {
                console.log('‚ùì Unknown format, returning as is:', dateString);
                return dateString.toString();
            }

            // Validate parsed values
            if (!day || !month || !year || isNaN(day) || isNaN(month) || isNaN(year)) {
                console.log('‚ùå Invalid parsed values:', { day, month, year });
                return dateString.toString();
            }

            console.log('‚úÖ Parsed values (corrected):', { day, month, year });

            // Format theo quy t·∫Øc dd/MM/yyyy Vi·ªát Nam
            const formattedDay = day.toString().padStart(2, '0'); // Lu√¥n 2 ch·ªØ s·ªë

            // Quy t·∫Øc th√°ng: ch·ªâ th√°ng 1,2 c√≥ s·ªë 0 ƒë·∫±ng tr∆∞·ªõc
            let formattedMonth;
            if (month === 1 || month === 2) {
                formattedMonth = month.toString().padStart(2, '0'); // 01, 02
            } else {
                formattedMonth = month.toString(); // 3, 4, 5, ..., 12
            }

            const result = `${formattedDay}/${formattedMonth}/${year}`;
            console.log('üéØ Final result:', result);

            return result;
        }

        // Format ng√†y d√†i cho template Word
        function formatDateLongForWord(dateString) {
            console.log('üîç formatDateLongForWord - Input:', dateString, typeof dateString);

            if (!dateString || dateString === 'Kh√¥ng c√≥ th√¥ng tin' || dateString === '') {
                console.log('‚ùå No date data, using today');
                const today = new Date();
                const day = today.getDate().toString().padStart(2, '0');
                const month = today.getMonth() + 1;
                const year = today.getFullYear();

                let formattedMonth;
                if (month === 1 || month === 2) {
                    formattedMonth = month.toString().padStart(2, '0');
                } else {
                    formattedMonth = month.toString();
                }

                const result = `${day} th√°ng ${formattedMonth} nƒÉm ${year}`;
                console.log('üéØ Today result:', result);
                return result;
            }

            let day, month, year;

            // X·ª¨ L√ù ƒê·ªäNH D·∫†NG MM/dd/yyyy t·ª´ AppSheet
            if (typeof dateString === 'string' && dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    month = parseInt(parts[0]); // MM
                    day = parseInt(parts[1]);   // dd  
                    year = parseInt(parts[2]);  // yyyy
                }
            } else if (typeof dateString === 'string' && dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    year = parseInt(parts[0]);
                    month = parseInt(parts[1]);
                    day = parseInt(parts[2]);
                }
            } else if (dateString instanceof Date) {
                day = dateString.getDate();
                month = dateString.getMonth() + 1;
                year = dateString.getFullYear();
            } else {
                console.log('‚ùì Unknown format in long date, returning as is');
                return dateString.toString();
            }

            if (!day || !month || !year || isNaN(day) || isNaN(month) || isNaN(year)) {
                console.log('‚ùå Invalid parsed values in long date:', { day, month, year });
                return dateString.toString();
            }

            const formattedDay = day.toString().padStart(2, '0');

            let formattedMonth;
            if (month === 1 || month === 2) {
                formattedMonth = month.toString().padStart(2, '0');
            } else {
                formattedMonth = month.toString();
            }

            const result = `${formattedDay} th√°ng ${formattedMonth} nƒÉm ${year}`;
            console.log('üéØ Long format result:', result);
            return result;
        }

        // Load data from AppSheet
        async function loadData() {
            try {
                updateStatus('loading', 'ƒêang t·∫£i d·ªØ li·ªáu...');

                const idHoSo = getIDHoSoFromURL();
                console.log('üîç ID t·ª´ URL:', idHoSo); // Debug

                if (!idHoSo) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y IDHoSo trong URL');
                }

                // Fetch d·ªØ li·ªáu t·ª´ c√°c b·∫£ng
                updateStatus('loading', 'ƒêang t·∫£i th√¥ng tin h·ªì s∆°...');
                const [hosoList, donviList, xeList, nhansuList] = await Promise.all([
                    fetchAppSheetData('HOSONHANSU', `Filter(HOSONHANSU, [IDHoSo] = "${idHoSo}")`),
                    fetchAppSheetData('THONGTINDONVI'),
                    fetchAppSheetData('THONGTINXE'),
                    fetchAppSheetData('THONGTINNHANSU')
                ]);

                console.log('Hoso data:', hosoList);
                console.log('Donvi data:', donviList);
                console.log('Xe data:', xeList);
                console.log('Nhansu data:', nhansuList);

                // Ki·ªÉm tra d·ªØ li·ªáu h·ªì s∆°
                if (!hosoList || hosoList.length === 0) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y h·ªì s∆° v·ªõi ID n√†y');
                }

                console.log('üîç T√¨m ki·∫øm ID:', idHoSo);
                console.log('üîç C√°c ID c√≥ s·∫µn:', hosoList.map(h => h.IDHoSo));

                // T√¨m record ch√≠nh x√°c thay v√¨ l·∫•y record ƒë·∫ßu ti√™n
                hosoData = hosoList.find(item => item.IDHoSo === idHoSo);

                if (!hosoData) {
                    const availableIDs = hosoList.map(h => h.IDHoSo).join(', ');
                    throw new Error(`Kh√¥ng t√¨m th·∫•y ID "${idHoSo}". C√°c ID c√≥ s·∫µn: ${availableIDs}`);
                }

                console.log('‚úÖ S·ª≠ d·ª•ng h·ªì s∆°:', hosoData);
                donviData = donviList.length > 0 ? donviList[0] : {};

                // T√¨m th√¥ng tin xe d·ª±a tr√™n Ref_Xe
                if (hosoData.Ref_Xe) {
                    const xe = xeList.find(x => x.Idxe === hosoData.Ref_Xe);
                    xeData = xe || {};
                } else {
                    xeData = {};
                }

                // T√¨m th√¥ng tin nh√¢n s·ª± d·ª±a tr√™n Ref_ThanhVien
                if (hosoData.Ref_ThanhVien) {
                    const nhansu = nhansuList.find(n => n.IDNS === hosoData.Ref_ThanhVien);
                    nhansuData = nhansu || {};
                } else {
                    nhansuData = {};
                }

                // T·∫°o d·ªØ li·ªáu cho template
                globalData = {
                    // Th√¥ng tin t·ª´ HOSONHANSU
                    IDHoSo: hosoData.IDHoSo || '',
                    Ref_ThanhVien: hosoData.Ref_ThanhVien || '',
                    SoVanBan: hosoData.SoVanBan || '',
                    NgayKy: formatDateLongForWord(hosoData.NgayKy),
                    NgayKy_Short: formatDateForWord(hosoData.NgayKy),
                    NgayHieuLuc: formatDateForWord(hosoData.NgayHieuLuc),
                    NgayHetHieuLuc: formatDateForWord(hosoData.NgayHetHieuLuc),
                    TrangThaiHoSo: hosoData.TrangThaiHoSo || '',

                    // Th√¥ng tin t·ª´ THONGTINDONVI
                    Tendonvi: donviData.Tendonvi || '',
                    Nguoidaidien: donviData.Nguoidaidien || '',
                    Diachidaydu: donviData.Diachi || '',
                    SoDT: donviData.SoDT || '',
                    Email: donviData.Email || '',
                    Masothue: donviData.SogiayCNDKKD || '',
                    SoTK: donviData.SoTK || '', // Th√™m tr∆∞·ªùng n√†y n·∫øu c√≥
                    TaiNganhang: donviData.TaiNganhang || '', // Th√™m tr∆∞·ªùng n√†y n·∫øu c√≥

                    // Th√¥ng tin t·ª´ THONGTINXE
                    Ref_Xe: xeData.Bienso || '',
                    Sokhung: xeData.Sokhung || '',
                    Somay: xeData.Somay || '',
                    Ghichu: xeData.Ghichu || '',

                    // Th√¥ng tin t·ª´ THONGTINNHANSU
                    Hoten: nhansuData.Hoten || '',
                    SoCCCD: nhansuData.NoCCCD || '',
                    Ngaysinh: formatDateForWord(nhansuData.Ngaysinh),
                    Gioitinh: nhansuData.Gioitinh || '',
                    DiachNhanSu: nhansuData.Diachidaydu || '',
                    Chucvu: nhansuData.Chucvu || '',
                    Trinhdo: nhansuData.Trinhdo || '',
                    SodienthoaiNS: nhansuData.Sodienthoai || '',
                    EmailNS: nhansuData.Email || ''
                };

                displayParameters();
                updateStatus('ready', 'D·ªØ li·ªáu ƒë√£ s·∫µn s√†ng');
                document.getElementById('export-button').disabled = false;

            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('error', `L·ªói: ${error.message}`);
                displayError(error.message);
            }
        }

        // Update status indicator
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status-indicator');
            statusEl.className = `status-indicator status-${type}`;

            let icon;
            switch (type) {
                case 'loading':
                    icon = 'fas fa-spinner fa-spin';
                    break;
                case 'ready':
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    break;
                default:
                    icon = 'fas fa-info-circle';
            }

            statusEl.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
        }

        // Display parameters
        function displayParameters() {
            const paramDisplay = document.getElementById('param-display');

            if (!globalData) {
                paramDisplay.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Kh√¥ng c√≥ d·ªØ li·ªáu</p>
                    </div>
                `;
                return;
            }

            const sectionsData = [
                {
                    title: 'Th√¥ng Tin H·ªì S∆°',
                    fields: [
                        { key: 'IDHoSo', label: 'ID H·ªì S∆°' },
                        { key: 'SoVanBan', label: 'S·ªë VƒÉn B·∫£n' },
                        { key: 'NgayKy_Short', label: 'Ng√†y K√Ω' },
                        { key: 'NgayHieuLuc', label: 'Ng√†y Hi·ªáu L·ª±c' },
                        { key: 'NgayHetHieuLuc', label: 'Ng√†y H·∫øt Hi·ªáu L·ª±c' },
                        { key: 'TrangThaiHoSo', label: 'Tr·∫°ng Th√°i' }
                    ]
                },
                {
                    title: 'Th√¥ng Tin ƒê∆°n V·ªã (B√™n A)',
                    fields: [
                        { key: 'Tendonvi', label: 'T√™n ƒê∆°n V·ªã' },
                        { key: 'Nguoidaidien', label: 'Ng∆∞·ªùi ƒê·∫°i Di·ªán' },
                        { key: 'Diachidaydu', label: 'ƒê·ªãa Ch·ªâ' },
                        { key: 'SoDT', label: 'S·ªë ƒêi·ªán Tho·∫°i' },
                        { key: 'Email', label: 'Email' },
                        { key: 'Masothue', label: 'M√£ S·ªë Thu·∫ø' }
                    ]
                },
                {
                    title: 'Th√¥ng Tin Th√†nh Vi√™n (B√™n B)',
                    fields: [
                        { key: 'Ref_ThanhVien', label: 'ID Th√†nh Vi√™n' },
                        { key: 'Hoten', label: 'H·ªç T√™n' },
                        { key: 'SoCCCD', label: 'S·ªë CCCD' },
                        { key: 'Ngaysinh', label: 'Ng√†y Sinh' },
                        { key: 'Gioitinh', label: 'Gi·ªõi T√≠nh' },
                        { key: 'DiachNhanSu', label: 'ƒê·ªãa Ch·ªâ' },
                        { key: 'Chucvu', label: 'Ch·ª©c V·ª•' },
                        { key: 'Trinhdo', label: 'Tr√¨nh ƒê·ªô' },
                        { key: 'SodienthoaiNS', label: 'S·ªë ƒêi·ªán Tho·∫°i' },
                        { key: 'EmailNS', label: 'Email' }
                    ]
                },
                {
                    title: 'Th√¥ng Tin Xe',
                    fields: [
                        { key: 'Ref_Xe', label: 'Bi·ªÉn S·ªë Xe' },
                        { key: 'Sokhung', label: 'S·ªë Khung' },
                        { key: 'Somay', label: 'S·ªë M√°y' },
                        { key: 'Ghichu', label: 'Ghi Ch√∫' }
                    ]
                }
            ];

            let html = '<div class="info-grid">';

            sectionsData.forEach(section => {
                html += `
                    <div class="info-section">
                        <div class="section-header">${section.title}</div>
                `;

                section.fields.forEach(field => {
                    const value = globalData[field.key] || 'Kh√¥ng c√≥ th√¥ng tin';
                    html += `
                        <div class="info-item">
                            <div class="info-label">${field.label}</div>
                            <div class="info-value">${value}</div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            html += '</div>';
            paramDisplay.innerHTML = html;
        }

        // Display error
        function displayError(message) {
            const paramDisplay = document.getElementById('param-display');
            paramDisplay.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>L·ªói: ${message}</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">Vui l√≤ng ki·ªÉm tra l·∫°i IDHoSo trong URL</p>
                    <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280;">
                        V√≠ d·ª•: ?IDHoSo=HS001
                    </p>
                </div>
            `;
        }

        // Export to Word using template
        async function exportToWordTemplate() {
            try {
                if (!globalData) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t. Vui l√≤ng t·∫£i l·∫°i trang.');
                    return;
                }

                // Show loading
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-text').textContent = 'ƒêang x·ª≠ l√Ω v√† xu·∫•t t√†i li·ªáu...';

                // URL template cho h·ª£p ƒë·ªìng d·ªãch v·ª•
                const templateUrl = 'templates/hddv_template.docx';
                // const templateUrl = 'https://hoangmv.github.io/templates/hddv_template.docx';

                let response;
                try {
                    response = await fetch(templateUrl);
                } catch (error) {
                    console.warn('Kh√¥ng th·ªÉ t·∫£i template, s·∫Ω t·∫°o file Word ƒë∆°n gi·∫£n');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i template Word');
                }

                const templateContent = await response.arrayBuffer();
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Set data cho template
                console.log('Data for template:', globalData);
                doc.setData(globalData);
                doc.render();

                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `HopDongDichVu_${globalData.SoVanBan}_${globalData.Hoten || 'Document'}.docx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('L·ªói xu·∫•t file Word:', error);
                alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t file Word: ' + error.message);
            } finally {
                // Hide loading
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // Initialize application
        async function initialize() {
            try {
                const idHoSo = getIDHoSoFromURL();
                if (!idHoSo) {
                    updateStatus('error', 'Thi·∫øu tham s·ªë IDHoSo trong URL');
                    displayError('Vui l√≤ng cung c·∫•p IDHoSo trong URL. V√≠ d·ª•: ?IDHoSo=HS001');
                    return;
                }

                await loadData();
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('error', 'L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng');
                displayError('Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Add slight delay for better UX
            setTimeout(() => {
                initialize();
            }, 500);
        });


        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };

        // Add error handling for fetch failures
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Unhandled promise rejection:', event.reason);
            updateStatus('error', 'L·ªói k·∫øt n·ªëi m·∫°ng');
        });
    </script>
</body>

</html>
